var nr=Object.defineProperty;var rr=(t,e)=>{for(var n in e)nr(t,n,{get:e[n],enumerable:!0,configurable:!0,set:(r)=>e[n]=()=>r})};var ir=(t,e)=>()=>(t&&(e=t(t=0)),e);async function Pt(t){let e=new CompressionStream("deflate-raw"),n=e.writable.getWriter();return n.write(t),n.close(),new Uint8Array(await new Response(e.readable).arrayBuffer())}async function kt(t){let e=new DecompressionStream("deflate-raw"),n=e.writable.getWriter();n.write(t),n.close();try{return new Uint8Array(await new Response(e.readable).arrayBuffer())}catch{throw Error("Failed to decompress data: invalid or corrupted")}}function Kt(){return typeof CompressionStream<"u"}var Be={};rr(Be,{toBase64Url:()=>Lt,fromBase64Url:()=>Fe,encodeFragment:()=>Vn,decodeFragment:()=>Yn});function Lt(t){let e="";for(let r=0;r<t.length;r++)e+=String.fromCharCode(t[r]);return btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function Fe(t){let e=t.replace(/-/g,"+").replace(/_/g,"/"),n=(4-e.length%4)%4;e+="=".repeat(n);let r=atob(e),i=new Uint8Array(r.length);for(let s=0;s<r.length;s++)i[s]=r.charCodeAt(s);return i}async function Vn(t){if(!Kt()){let n=new Uint8Array(1+t.length);return n[0]=Le,n.set(t,1),Lt(n)}let e=await Pt(t);if(e.length<t.length){let n=new Uint8Array(1+e.length);return n[0]=Jn,n.set(e,1),Lt(n)}else{let n=new Uint8Array(1+t.length);return n[0]=Le,n.set(t,1),Lt(n)}}async function Yn(t){let e=Fe(t);if(e.length===0)throw Error("Empty fragment");let n=e[0],r=e.slice(1);if(n===Le)return r;if(n===Jn)return kt(r);return e}var Le=0,Jn=1;var ce=()=>{};var et=2,ue=1,nt=1,me=-1,ut=-2,mt=-3,wt=-4,gt=16,dt=96;var $e=45,Ge=53,Re=1,rt=-4;function We(t,e,n){let r=O(e,n);return sr(t,r)}function Ce(t){if(t>=Number.MAX_SAFE_INTEGER)throw new jt("Sequence number overflow");return++t}async function Xe(t,e,n,r){U(n,"exporterContext");let i=Ye(t.KDF);if(!Number.isInteger(r)||r<=0||r>65535)throw TypeError('"L" must be a positive integer not exceeding 65535');return await(i===1?or:cr)(t.KDF,t.id,e,n,r)}class Ee{#t=Promise.resolve();async lock(){let t,e=new Promise((r)=>{t=r}),n=this.#t;return this.#t=e,await n,t}}class Ze{#t;#e;#n;#r;#i;#s=0;#o;constructor(t,e,n,r,i){this.#t=t,this.#i=e,this.#e=n,this.#n=r,this.#r=i}get mode(){return this.#i}get seq(){return this.#s}async Seal(t,e){if(U(t,"plaintext"),e??=new Uint8Array,U(e,"aad"),this.#t.AEAD.id===Tt)throw TypeError("Export-only AEAD cannot be used with Seal");this.#o??=new Ee;let n=await this.#o.lock(),r;try{return r=await this.#t.AEAD.Seal(this.#e,We(this.#n,this.#s,this.#t.AEAD.Nn),e,t),this.#s=Ce(this.#s),r}finally{n()}}async Export(t,e){return await Xe(this.#t,this.#r,t,e)}get Nt(){return this.#t.AEAD.Nt}}class Je{#t;#e;#n;#r;#i;#s=0;#o;constructor(t,e,n,r,i){this.#t=t,this.#i=e,this.#e=n,this.#n=r,this.#r=i}get mode(){return this.#i}get seq(){return this.#s}async Open(t,e){if(U(t,"ciphertext"),e??=new Uint8Array,U(e,"aad"),this.#t.AEAD.id===Tt)throw TypeError("Export-only AEAD cannot be used with Open");this.#o??=new Ee;let n=await this.#o.lock();try{let r;try{r=await this.#t.AEAD.Open(this.#e,We(this.#n,this.#s,this.#t.AEAD.Nn),e,t)}catch(i){if(i instanceof jt||i instanceof B)throw i;throw new be("AEAD decryption failed",{cause:i})}return this.#s=Ce(this.#s),r}finally{n()}}async Export(t,e){return await Xe(this.#t,this.#r,t,e)}}var we=(t,e)=>{try{let n=t();if(n.type!==e)throw Error(`Invalid "${e}" return discriminator`);return n}catch(n){throw TypeError(`Invalid "${e}"`,{cause:n})}};class St{#t;constructor(t,e,n){let r=we(t,"KEM"),i=we(e,"KDF"),s=we(n,"AEAD");this.#t={KEM:r,KDF:i,AEAD:s,id:M(b("HPKE"),O(r.id,2),O(i.id,2),O(s.id,2))}}get KEM(){return{id:this.#t.KEM.id,name:this.#t.KEM.name,Nsecret:this.#t.KEM.Nsecret,Nenc:this.#t.KEM.Nenc,Npk:this.#t.KEM.Npk,Nsk:this.#t.KEM.Nsk}}get KDF(){return{id:this.#t.KDF.id,name:this.#t.KDF.name,stages:this.#t.KDF.stages,Nh:this.#t.KDF.Nh}}get AEAD(){return{id:this.#t.AEAD.id,name:this.#t.AEAD.name,Nk:this.#t.AEAD.Nk,Nn:this.#t.AEAD.Nn,Nt:this.#t.AEAD.Nt}}async GenerateKeyPair(t){return t??=!1,ge(t),await this.#t.KEM.GenerateKeyPair(t)}async DeriveKeyPair(t,e){if(e??=!1,ge(e),U(t,"ikm"),t.byteLength<this.#t.KEM.Nsk)throw new At('Insufficient "ikm" length');try{return await this.#t.KEM.DeriveKeyPair(t,e)}catch(n){if(n instanceof B)throw n;throw new At("Key derivation failed",{cause:n})}}async SerializePrivateKey(t){return it(t,"private",!0),await this.#t.KEM.SerializePrivateKey(t)}async SerializePublicKey(t){return it(t,"public",!0),await this.#t.KEM.SerializePublicKey(t)}async DeserializePrivateKey(t,e){e??=!1,ge(e),U(t,"privateKey");try{if(t.byteLength!==this.#t.KEM.Nsk)throw Error('Invalid "privateKey" length');return await this.#t.KEM.DeserializePrivateKey(t,e)}catch(n){if(n instanceof B)throw n;throw new Gt("Private key deserialization failed",{cause:n})}}async DeserializePublicKey(t){U(t,"publicKey");try{if(t.byteLength!==this.#t.KEM.Npk)throw Error('Invalid "publicKey" length');return await this.#t.KEM.DeserializePublicKey(t)}catch(e){if(e instanceof B)throw e;throw new Gt("Public key deserialization failed",{cause:e})}}async Seal(t,e,n){if(this.#t.AEAD.id===Tt)throw TypeError("Export-only AEAD cannot be used with Seal");let{encapsulatedSecret:r,ctx:i}=await this.SetupSender(t,n),s=await i.Seal(e,n?.aad);return{encapsulatedSecret:r,ciphertext:s}}async Open(t,e,n,r){if(this.#t.AEAD.id===Tt)throw TypeError("Export-only AEAD cannot be used with Open");return await(await this.SetupRecipient(t,e,r)).Open(n,r?.aad)}async SendExport(t,e,n,r){let{encapsulatedSecret:i,ctx:s}=await this.SetupSender(t,r),o=await s.Export(e,n);return{encapsulatedSecret:i,exportedSecret:o}}async ReceiveExport(t,e,n,r,i){return await(await this.SetupRecipient(t,e,i)).Export(n,r)}async SetupSender(t,e){it(t,"public");let n,r;try{let h=await this.#t.KEM.Encap(t);n=h.shared_secret,r=h.enc}catch(h){if(h instanceof Nt||h instanceof B)throw h;throw new pe("Encapsulation failed",{cause:h})}let i=e?.psk?.byteLength?ze:je,{key:s,base_nonce:o,exporter_secret:a}=await He(this.#t,i,n,e?.info,e?.psk,e?.pskId),f=new Ze(this.#t,i,s,o,a);return{encapsulatedSecret:r,ctx:f}}async SetupRecipient(t,e,n){let{skR:r,pkR:i}=this.#e(t);if(U(e,"encapsulatedSecret"),e.byteLength!==this.#t.KEM.Nenc)throw new Rt("Invalid encapsulated secret length");let s;try{s=await this.#t.KEM.Decap(e,r,i)}catch(l){if(l instanceof Nt||l instanceof B)throw l;throw new Rt("Decapsulation failed",{cause:l})}let o=n?.psk?.byteLength?ze:je,{key:a,base_nonce:f,exporter_secret:h}=await He(this.#t,o,s,n?.info,n?.psk,n?.pskId);return new Je(this.#t,o,a,f,h)}#e(t){if(hr(t))return{skR:t.privateKey,pkR:t.publicKey};return it(t,"private"),{skR:t,pkR:void 0}}}class Nt extends Error{constructor(t,e){super(t,e);this.name="ValidationError",Error.captureStackTrace?.(this,Nt)}}class Gt extends Error{constructor(t,e){super(t,e);this.name="DeserializeError",Error.captureStackTrace?.(this,Gt)}}class pe extends Error{constructor(t,e){super(t,e);this.name="EncapError",Error.captureStackTrace?.(this,pe)}}class Rt extends Error{constructor(t,e){super(t,e);this.name="DecapError",Error.captureStackTrace?.(this,Rt)}}class be extends Error{constructor(t,e){super(t,e);this.name="OpenError",Error.captureStackTrace?.(this,be)}}class jt extends Error{constructor(t,e){super(t,e);this.name="MessageLimitReachedError",Error.captureStackTrace?.(this,jt)}}class At extends Error{constructor(t,e){super(t,e);this.name="DeriveKeyPairError",Error.captureStackTrace?.(this,At)}}class B extends Error{constructor(t,e){super(t,e);this.name="NotSupportedError",Error.captureStackTrace?.(this,B)}}var je=0,ze=1;function M(...t){let e=t.reduce((i,{length:s})=>i+s,0),n=new Uint8Array(e),r=0;for(let i of t)n.set(i,r),r+=i.length;return n}function xt(t,e,n){return Uint8Array.prototype.slice.call(t,e,n)}function b(t){let e=new Uint8Array(t.length);for(let n=0;n<t.length;n++){let r=t.charCodeAt(n);if(r>127)throw TypeError("Input string must contain only ASCII characters");e[n]=r}return e}function sr(t,e){if(t.byteLength!==e.byteLength)throw Error("XOR operands must have equal length");let n=new Uint8Array(t.byteLength);for(let r=0;r<t.byteLength;r++)n[r]=t[r]^e[r];return n}function bt(t){return M(O(t.byteLength,2),t)}async function Ve(t,e,n,r,i,s){let o=M(n,b("HPKE-v1"),e,bt(r),O(s,2),i);return await t.Derive(o,s)}async function or(t,e,n,r,i){return j(r,"Exporter context",$t),await Ve(t,e,n,b("sec"),r,i)}async function ar(t,e,n,r,i,s){j(i,"PSK",$t),j(s,"PSK ID",$t),j(r,"Info",$t);let o=M(bt(i),bt(n)),a=M(O(e,1),bt(s),bt(r)),f=await Ve(t.KDF,t.id,o,b("secret"),a,t.AEAD.Nk+t.AEAD.Nn+t.KDF.Nh),h=xt(f,0,t.AEAD.Nk),l=xt(f,t.AEAD.Nk,t.AEAD.Nk+t.AEAD.Nn),u=xt(f,t.AEAD.Nk+t.AEAD.Nn);return{key:h,base_nonce:l,exporter_secret:u}}var Bt=65535,$t=65535;function j(t,e,n){if(t.byteLength>n)throw TypeError(`${e} length must not exceed ${n} bytes`)}function U(t,e){if(!(t instanceof Uint8Array))throw TypeError(`"${e}" must be Uint8Array`)}function ge(t){if(typeof t!=="boolean")throw TypeError('"extractable" must be boolean')}async function fr(t,e,n,r,i,s){j(i,"PSK",Bt),j(s,"PSK ID",Bt),j(r,"Info",Bt);let[o,a]=await Promise.all([st(t.KDF,t.id,new Uint8Array,b("psk_id_hash"),s),st(t.KDF,t.id,new Uint8Array,b("info_hash"),r)]),f=M(O(e,1),o,a),h=await st(t.KDF,t.id,n,b("secret"),i);if(t.AEAD.id===Tt){let F=await R(t.KDF,t.id,h,b("exp"),f,t.KDF.Nh);return{key:new Uint8Array,base_nonce:new Uint8Array,exporter_secret:F}}let[l,u,d]=await Promise.all([R(t.KDF,t.id,h,b("key"),f,t.AEAD.Nk),R(t.KDF,t.id,h,b("base_nonce"),f,t.AEAD.Nn),R(t.KDF,t.id,h,b("exp"),f,t.KDF.Nh)]);return{key:l,base_nonce:u,exporter_secret:d}}async function cr(t,e,n,r,i){return j(r,"Exporter context",Bt),await R(t,e,n,b("sec"),r,i)}async function st(t,e,n,r,i){let s=M(b("HPKE-v1"),e,r,i);return await t.Extract(n,s)}async function R(t,e,n,r,i,s){let o=M(O(s,2),b("HPKE-v1"),e,r,i);return await t.Expand(n,o,s)}function hr(t){if(!t||typeof t!=="object")return!1;if("publicKey"in t&&"privateKey"in t){let e=t.publicKey;t=t.privateKey;try{if(it(e,"public"),it(t,"private"),e.algorithm.name!==t.algorithm.name)throw TypeError("key pair algorithms do not match")}catch(n){throw TypeError('Invalid "privateKey"',{cause:n})}return!0}return!1}function it(t,e,n){let r=t;if(typeof r.algorithm!=="object"||typeof r.algorithm.name!=="string"||typeof r.extractable!=="boolean"||typeof r.type!=="string"||r.type!==e)throw TypeError(`Invalid "${e}Key"`);if(n&&r.extractable!==!0)throw TypeError(`"${e}Key" must be extractable`)}function O(t,e){if(!Number.isSafeInteger(e)||e<=0)throw Error("w must be a positive safe integer");if(!Number.isSafeInteger(t)||t<0)throw Error("n must be a non-negative safe integer");let n=Math.pow(256,e);if(t>=n)throw Error("n too large to fit in w-length byte string");let r=new Uint8Array(e),i=t;for(let s=0;s<e&&i;s++)r[e-(s+1)]=i%256,i=Math.floor(i/256);return r}function Ye(t){if(t.stages===1||t.stages===2)return t.stages;throw Error("unreachable")}async function He(t,e,n,r,i,s){r??=new Uint8Array,U(r,"info"),i??=new Uint8Array,U(i,"psk"),s??=new Uint8Array,U(s,"pskId");let a=Ye(t.KDF)===1?ar:fr;return lr(i,s),await a(t,e,n,r,i,s)}function lr(t,e){if(t.byteLength&&e.byteLength){if(t.byteLength<32)throw TypeError("Insufficient PSK length");return}if(!t.byteLength&&!e.byteLength)return;throw TypeError("Inconsistent PSK inputs")}var ur=()=>{throw Error("unreachable")},Tt=65535;async function T(t,e){try{return await t(crypto.subtle)}catch(n){if(n instanceof TypeError||n instanceof DOMException&&n.name==="NotSupportedError")throw new B(`${e} is unsupported in this runtime`,{cause:n});throw n}}function mr(t){return typeof SharedArrayBuffer<"u"&&t instanceof SharedArrayBuffer}function _(t){if(mr(t.buffer))throw TypeError("input must not be a SharedArrayBuffer");if(t.byteLength===t.buffer.byteLength)return t.buffer;return t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)}function wr(){return{stages:2,Derive:ur,async Extract(t,e){let n;if(t.byteLength===0)n=new ArrayBuffer(this.Nh);else n=_(t);let r=_(e);return new Uint8Array(await T(async(i)=>i.sign("HMAC",await i.importKey("raw",n,{name:"HMAC",hash:this.hash},!1,["sign"]),r),this.name))},async Expand(t,e,n){if(t.byteLength<this.Nh)throw Error("prk.byteLength < this.Nh");if(n>255*this.Nh)throw Error("L must be <= 255*Nh");let r=Math.ceil(n/this.Nh),i=_(t),s=await T((f)=>f.importKey("raw",i,{name:"HMAC",hash:this.hash},!1,["sign"]),this.name),o=new Uint8Array(r*this.Nh),a=new Uint8Array;for(let f=0;f<r;f++){let h=new Uint8Array(a.byteLength+e.byteLength+1);h.set(a),h.set(e,a.byteLength),h[a.byteLength+e.byteLength]=f+1;let l=new Uint8Array(await T((u)=>u.sign("HMAC",s,h),this.name));o.set(l,f*this.Nh),a=l}return xt(o,0,n)}}}var Dt=function(){return{id:1,type:"KDF",name:"HKDF-SHA256",Nh:32,hash:"SHA-256",...wr()}};async function gr(t,e,n){if(!e.extractable)throw TypeError('"privateKey" must be extractable or a Key Pair must be used in this runtime');return await T(async(r)=>{let i=await r.exportKey("jwk",e);return r.importKey("jwk",{kty:i.kty,crv:i.crv,x:i.x,y:i.y},e.algorithm,!0,n)},t)}async function dr(t,e,n){return await T((r)=>r.getPublicKey?.(e,n),t)||await gr(t,e,n)}function qe(t){let e=0;for(let n=0;n<t.length;n++)e|=t[n];if(e===0)throw new Nt("DH shared secret is an all-zero value")}function yr(t){t=t.replace(/-/g,"+").replace(/_/g,"/");let e=atob(t),n=new Uint8Array(e.length);for(let r=0;r<e.length;r++)n[r]=e.charCodeAt(r);return n}function Er(t){let e="";for(let n=0;n<t.length;n++)e+=String.fromCharCode(t[n]);return btoa(e).replaceAll("+","-").replaceAll("/","_").replaceAll("=","")}function de(t){return t.toBase64?.({alphabet:"base64url",omitPadding:!0})||Er(t)}function pr(t){return Uint8Array.fromBase64?.(t,{alphabet:"base64url"})||yr(t)}async function br(t,e,n,r){let i=await st(t.kdf,e,new Uint8Array,b("dkp_prk"),n);return await R(t.kdf,e,i,b("candidate"),O(r,1),t.Nsk)}function xe(t){let e=0n;for(let n=0;n<t.byteLength;n++)e=e*256n+BigInt(t[n]);return e}function ye(t,e){let n=new Uint8Array(e),r=t;for(let i=e-1;i>=0;i--)n[i]=Number(r&0xffn),r=r>>8n;return n}function yt(t,e){if(t.algorithm.name!==e.name)throw TypeError(`key algorithm must be ${e.name}`);if(t.algorithm.namedCurve!==e.namedCurve)throw TypeError(`key namedCurve must be ${e.namedCurve}`)}function Et(t){if(t[Symbol.toStringTag]!=="CryptoKey"){if(t instanceof CryptoKey)return;throw TypeError("unexpected key constructor")}}function xr(){return{async GenerateKeyPair(t){return await T((e)=>e.generateKey(this.algorithm,t,["deriveBits"]),this.name)},async SerializePublicKey(t){return yt(t,this.algorithm),Et(t),new Uint8Array(await T((e)=>e.exportKey("raw",t),this.name))},async DeserializePublicKey(t){let e=_(t);return await T((n)=>n.importKey("raw",e,this.algorithm,!0,[]),this.name)},async SerializePrivateKey(t){yt(t,this.algorithm),Et(t);let{d:e}=await T((n)=>n.exportKey("jwk",t),this.name);return pr(e)},async Encap(t){yt(t,this.algorithm),Et(t);let e=await this.GenerateKeyPair(!1),n=e.privateKey,r=e.publicKey,i=new Uint8Array(await T((l)=>l.deriveBits({name:n.algorithm.name,public:t},n,this.Ndh<<3),this.name));qe(i);let s=await this.SerializePublicKey(r),o=await this.SerializePublicKey(t),a=M(s,o),f=await st(this.kdf,this.suite_id,new Uint8Array,b("eae_prk"),i);return{shared_secret:await R(this.kdf,this.suite_id,f,b("shared_secret"),a,this.Nsecret),enc:s}},async Decap(t,e,n){if(yt(e,this.algorithm),Et(e),n)yt(n,this.algorithm),Et(n);else n=await dr(this.name,e,[]);let r=await this.DeserializePublicKey(t),i=new Uint8Array(await T((h)=>h.deriveBits({name:e.algorithm.name,public:r},e,this.Ndh<<3),this.name));qe(i);let s=await this.SerializePublicKey(n),o=M(t,s),a=await st(this.kdf,this.suite_id,new Uint8Array,b("eae_prk"),i);return await R(this.kdf,this.suite_id,a,b("shared_secret"),o,this.Nsecret)}}}function Qe(t,e){t=(t%e+e)%e;let[n,r]=[0n,1n],[i,s]=[e,t];while(s!==0n){let o=i/s;[n,r]=[r,n-o*r],[i,s]=[s,i-o*s]}if(i>1n)throw Error("a is not invertible");if(n<0n)n=n+e;return n}function tn(t,e,n){let{x:r,y:i}=t,s=(3n*r*r%e+n)%e,o=2n*i%e,a=s*Qe(o,e)%e,f=(a*a%e-2n*r%e+e)%e,h=(a*((r-f+e)%e)%e-i+e)%e;return{x:f,y:h}}function Nr(t,e,n,r){if(t.x===e.x&&t.y===e.y)return tn(t,n,r);let{x:i,y:s}=t,{x:o,y:a}=e;if(t.x===e.x)throw Error("Point addition resulted in point at infinity");let f=((a-s)%n+n)%n,h=((o-i)%n+n)%n,l=f*Qe(h,n)%n,u=(l*l%n-i-o+n+n)%n,d=(l*((i-u+n)%n)%n-s+n)%n;return{x:u,y:d}}function Ar(t,e,n,r,i){if(t===0n||t>=i)throw Error("Invalid scalar");let s=null,o=e,a=t;while(a>0n){if(a&1n)s=s===null?o:Nr(s,o,n,r);o=tn(o,n,r),a=a>>1n}if(s===null)throw Error("Invalid result");return s}function en(t,e){let n={x:t.Gx,y:t.Gy},r=Ar(e,n,t.prime,t.prime-3n,t.order),i=(t.Npk-1)/2,s=ye(r.x,i),o=ye(r.y,i),a=ye(e,t.Nsk);return{kty:"EC",crv:t.algorithm.namedCurve,x:de(s),y:de(o),d:de(a)}}async function Tr(t,e){let n=xe(t),r=en(this,n);return await T((s)=>s.importKey("jwk",r,this.algorithm,e,["deriveBits"]),this.name)}async function Sr(t,e){let n=0n,r=0,i;while(n===0n||n>=this.order){if(r>255)throw new At("Key derivation exceeded maximum iterations");i=await br(this,this.suite_id,t,r),i[0]=i[0]&this.bitmask,n=xe(i),r=r+1}return Dr(this,i,e,this.name)}async function Dr(t,e,n,r){let i=en(t,xe(e)),s=await T((a)=>a.importKey("jwk",i,t.algorithm,n,["deriveBits"]),r);delete i.d;let o=await T((a)=>a.importKey("jwk",i,t.algorithm,!0,[]),r);return{privateKey:s,publicKey:o}}var Ir={algorithm:{name:"ECDH",namedCurve:"P-256"},Npk:65,Nsk:32,order:0xffffffff00000000ffffffffffffffffbce6faada7179e84f3b9cac2fc632551n,bitmask:255,prime:0xffffffff00000001000000000000000000000000ffffffffffffffffffffffffn,Gx:0x6b17d1f2e12c4247f8bce6e563a440f277037d812deb33a0f4a13945d898c296n,Gy:0x4fe342e2fe1a7f9b8ee7eb4a7c0f9e162bce33576b315ececbb6406837bf51f5n},zt=function(){let n=Dt();return n.name="DHKEM(P-256, HKDF-SHA256)",{id:16,suite_id:M(b("KEM"),O(16,2)),type:"KEM",name:"DHKEM(P-256, HKDF-SHA256)",kdf:n,Nsecret:32,Nenc:65,Ndh:32,...Ir,DeriveKeyPair:Sr,DeserializePrivateKey:Tr,...xr()}};function _r(){return{async Seal(t,e,n,r){let i=_(e),s=_(n),o=_(t),a=_(r);return new Uint8Array(await T(async(f)=>f.encrypt({name:this.algorithm,iv:i,additionalData:s},await f.importKey(this.keyFormat,o,this.algorithm,!1,["encrypt"]),a),this.name))},async Open(t,e,n,r){let i=_(e),s=_(n),o=_(t),a=_(r);return new Uint8Array(await T(async(f)=>f.decrypt({name:this.algorithm,iv:i,additionalData:s},await f.importKey(this.keyFormat,o,this.algorithm,!1,["decrypt"]),a),this.name))}}}var Ht=function(){return{id:2,type:"AEAD",name:"AES-256-GCM",Nk:32,Nn:12,Nt:16,algorithm:"AES-GCM",keyFormat:"raw",..._r()}};var pt=(t)=>{if(t!==Ur)throw Error("invalid invocation")},Ur=Symbol();class nn{#t;#e;#n;#r;#i;#s;#o;static#c(t){return t.#t!==void 0}static validate(t,e){try{if(!nn.#c(t))throw TypeError("unexpected key constructor")}catch{throw TypeError("unexpected key constructor")}if(e&&!t.extractable)throw TypeError("key must be extractable")}constructor(t,e,n,r,i,s,o,a){pt(t),this.#t=e,this.#e=n,this.#n=r,this.#i=i,this.#r=s,this.#s=o,this.#o=a}get algorithm(){return{name:this.#t.name}}get extractable(){return this.#n}get type(){return this.#e}getPublicKey(t){return pt(t),this.#o}getSeed(t){return pt(t),xt(this.#s)}getT(t){return pt(t),this.#r}getPq(t){return pt(t),this.#i}}var c={POS_INT:0,NEG_INT:1,BYTE_STRING:2,UTF8_STRING:3,ARRAY:4,MAP:5,TAG:6,SIMPLE_FLOAT:7},g={DATE_STRING:0,DATE_EPOCH:1,POS_BIGINT:2,NEG_BIGINT:3,DECIMAL_FRAC:4,BIGFLOAT:5,BASE64URL_EXPECTED:21,BASE64_EXPECTED:22,BASE16_EXPECTED:23,CBOR:24,URI:32,BASE64URL:33,BASE64:34,MIME:36,SET:258,JSON:262,WTF8:273,REGEXP:21066,SELF_DESCRIBED:55799,INVALID_16:65535,INVALID_32:4294967295,INVALID_64:0xffffffffffffffffn},w={ZERO:0,ONE:24,TWO:25,FOUR:26,EIGHT:27,INDEFINITE:31},K={FALSE:20,TRUE:21,NULL:22,UNDEFINED:23};class E{static BREAK=Symbol.for("github.com/hildjj/cbor2/break");static ENCODED=Symbol.for("github.com/hildjj/cbor2/cbor-encoded");static LENGTH=Symbol.for("github.com/hildjj/cbor2/length")}var ot={MIN:-(2n**63n),MAX:2n**64n-1n};class m{static#t=new Map;tag;contents;constructor(t,e=void 0){this.tag=t,this.contents=e}get noChildren(){return!!m.#t.get(this.tag)?.noChildren}static registerDecoder(t,e,n){let r=this.#t.get(t);return this.#t.set(t,e),r&&(("comment"in e)||(e.comment=r.comment),("noChildren"in e)||(e.noChildren=r.noChildren)),n&&!e.comment&&(e.comment=()=>`(${n})`),r}static clearDecoder(t){let e=this.#t.get(t);return this.#t.delete(t),e}static getDecoder(t){return this.#t.get(t)}static getAllDecoders(){return new Map(this.#t)}*[Symbol.iterator](){yield this.contents}push(t){return this.contents=t,1}decode(t){let e=t?.tags?.get(this.tag)??m.#t.get(this.tag);return e?e(this,t):this}comment(t,e){let n=t?.tags?.get(this.tag)??m.#t.get(this.tag);if(n?.comment)return n.comment(this,t,e)}toCBOR(){return[this.tag,this.contents]}[Symbol.for("nodejs.util.inspect.custom")](t,e,n){return`${this.tag}(${n(this.contents,e)})`}}function z(t){if(t!=null&&typeof t=="object")return t[E.ENCODED]}function rn(t){if(t!=null&&typeof t=="object")return t[E.LENGTH]}function H(t,e){Object.defineProperty(t,E.ENCODED,{configurable:!0,enumerable:!1,value:e})}function q(t,e){let n=Object(t);return H(n,e),n}var Ne=Symbol("CBOR_RANGES");function sn(t,e){Object.defineProperty(t,Ne,{configurable:!1,enumerable:!1,writable:!1,value:e})}function It(t){return t[Ne]}function vr(t){return It(t)!==void 0}function _t(t,e=0,n=t.length-1){let r=t.subarray(e,n),i=It(t);if(i){let s=[];for(let o of i)if(o[0]>=e&&o[0]+o[1]<=n){let a=[...o];a[0]-=e,s.push(a)}s.length&&sn(r,s)}return r}function qt(t){let e=Math.ceil(t.length/2),n=new Uint8Array(e);e--;for(let r=t.length,i=r-2;r>=0;r=i,i-=2,e--)n[e]=parseInt(t.substring(i,r),16);return n}function A(t){return t.reduce((e,n)=>e+n.toString(16).padStart(2,"0"),"")}function on(t){let e=t.reduce((o,a)=>o+a.length,0),n=t.some((o)=>vr(o)),r=[],i=new Uint8Array(e),s=0;for(let o of t){if(!(o instanceof Uint8Array))throw TypeError(`Invalid array: ${o}`);if(i.set(o,s),n){let a=o[Ne]??[[0,o.length]];for(let f of a)f[0]+=s;r.push(...a)}s+=o.length}return n&&sn(i,r),i}function Ut(t){let e=atob(t);return Uint8Array.from(e,(n)=>n.codePointAt(0))}var Or={"-":"+",_:"/"};function an(t){let e=t.replace(/[_-]/g,(n)=>Or[n]);return Ut(e.padEnd(Math.ceil(e.length/4)*4,"="))}function fn(){let t=new Uint8Array(4),e=new Uint32Array(t.buffer);return!((e[0]=1)&t[0])}function Ae(t){let e="";for(let n of t){let r=n.codePointAt(0)?.toString(16).padStart(4,"0");e&&(e+=", "),e+=`U+${r}`}return e}class Wt{#t=new Map;registerEncoder(t,e){let n=this.#t.get(t);return this.#t.set(t,e),n}get(t){return this.#t.get(t)}delete(t){return this.#t.delete(t)}clear(){this.#t.clear()}}function Ct(t,e){let[n,r,i]=t,[s,o,a]=e,f=Math.min(i.length,a.length);for(let h=0;h<f;h++){let l=i[h]-a[h];if(l!==0)return l}return 0}class at{static defaultOptions={chunkSize:4096};#t;#e=[];#n=null;#r=0;#i=0;constructor(t={}){if(this.#t={...at.defaultOptions,...t},this.#t.chunkSize<8)throw RangeError(`Expected size >= 8, got ${this.#t.chunkSize}`);this.#s()}get length(){return this.#i}read(){this.#o();let t=new Uint8Array(this.#i),e=0;for(let n of this.#e)t.set(n,e),e+=n.length;return this.#s(),t}write(t){let e=t.length;e>this.#c()?(this.#o(),e>this.#t.chunkSize?(this.#e.push(t),this.#s()):(this.#s(),this.#e[this.#e.length-1].set(t),this.#r=e)):(this.#e[this.#e.length-1].set(t,this.#r),this.#r+=e),this.#i+=e}writeUint8(t){this.#a(1),this.#n.setUint8(this.#r,t),this.#f(1)}writeUint16(t,e=!1){this.#a(2),this.#n.setUint16(this.#r,t,e),this.#f(2)}writeUint32(t,e=!1){this.#a(4),this.#n.setUint32(this.#r,t,e),this.#f(4)}writeBigUint64(t,e=!1){this.#a(8),this.#n.setBigUint64(this.#r,t,e),this.#f(8)}writeInt16(t,e=!1){this.#a(2),this.#n.setInt16(this.#r,t,e),this.#f(2)}writeInt32(t,e=!1){this.#a(4),this.#n.setInt32(this.#r,t,e),this.#f(4)}writeBigInt64(t,e=!1){this.#a(8),this.#n.setBigInt64(this.#r,t,e),this.#f(8)}writeFloat32(t,e=!1){this.#a(4),this.#n.setFloat32(this.#r,t,e),this.#f(4)}writeFloat64(t,e=!1){this.#a(8),this.#n.setFloat64(this.#r,t,e),this.#f(8)}clear(){this.#i=0,this.#e=[],this.#s()}#s(){let t=new Uint8Array(this.#t.chunkSize);this.#e.push(t),this.#r=0,this.#n=new DataView(t.buffer,t.byteOffset,t.byteLength)}#o(){if(this.#r===0){this.#e.pop();return}let t=this.#e.length-1;this.#e[t]=this.#e[t].subarray(0,this.#r),this.#r=0,this.#n=null}#c(){let t=this.#e.length-1;return this.#e[t].length-this.#r}#a(t){this.#c()<t&&(this.#o(),this.#s())}#f(t){this.#r+=t,this.#i+=t}}function Te(t,e=0,n=!1){let r=t[e]&128?-1:1,i=(t[e]&124)>>2,s=(t[e]&3)<<8|t[e+1];if(i===0){if(n&&s!==0)throw Error(`Unwanted subnormal: ${r*0.00000005960464477539063*s}`);return r*0.00000005960464477539063*s}else if(i===31)return s?NaN:r*(1/0);return r*2**(i-25)*(1024+s)}function Xt(t){let e=new DataView(new ArrayBuffer(4));e.setFloat32(0,t,!1);let n=e.getUint32(0,!1);if((n&8191)!==0)return null;let r=n>>16&32768,i=n>>23&255,s=n&8388607;if(!(i===0&&s===0))if(i>=113&&i<=142)r+=(i-112<<10)+(s>>13);else if(i>=103&&i<113){if(s&(1<<126-i)-1)return null;r+=s+8388608>>126-i}else if(i===255)r|=31744,r|=s>>13;else return null;return r}function cn(t){if(t!==0){let e=new ArrayBuffer(8),n=new DataView(e);n.setFloat64(0,t,!1);let r=n.getBigUint64(0,!1);if((r&0x7ff0000000000000n)===0n)return r&0x8000000000000000n?-0:0}return t}function hn(t){switch(t.length){case 2:Te(t,0,!0);break;case 4:{let e=new DataView(t.buffer,t.byteOffset,t.byteLength),n=e.getUint32(0,!1);if((n&2139095040)===0&&n&8388607)throw Error(`Unwanted subnormal: ${e.getFloat32(0,!1)}`);break}case 8:{let e=new DataView(t.buffer,t.byteOffset,t.byteLength),n=e.getBigUint64(0,!1);if((n&0x7ff0000000000000n)===0n&&n&0x000fffffffffffn)throw Error(`Unwanted subnormal: ${e.getFloat64(0,!1)}`);break}default:throw TypeError(`Bad input to isSubnormal: ${t}`)}}class Zt extends TypeError{code="ERR_ENCODING_INVALID_ENCODED_DATA";constructor(){super("The encoded data was not valid for encoding wtf-8")}}class Se extends RangeError{code="ERR_ENCODING_NOT_SUPPORTED";constructor(t){super(`Invalid encoding: "${t}"`)}}var ln=65279,Jt=new Uint8Array(0),un=56319;var Vt=55296,mn=56320,wn=65533,Yt="wtf-8";function Mr(t){return t&&!(t instanceof ArrayBuffer)&&t.buffer instanceof ArrayBuffer}function Pr(t){if(!t)return Jt;if(t instanceof Uint8Array)return t;if(Mr(t))return new Uint8Array(t.buffer,t.byteOffset,t.byteLength);return new Uint8Array(t)}var kr=[0,0,0,0,0,0,0,0,-1,-1,-1,-1,1,1,2,3];class W{static DEFAULT_BUFFERSIZE=4096;encoding=Yt;fatal;ignoreBOM;bufferSize;#t=0;#e=0;#n=0;#r=!0;#i;constructor(t="wtf8",e=void 0){if(t.toLowerCase().replace("-","")!=="wtf8")throw new Se(t);if(this.fatal=Boolean(e?.fatal),this.ignoreBOM=Boolean(e?.ignoreBOM),this.bufferSize=Math.floor(e?.bufferSize??W.DEFAULT_BUFFERSIZE),isNaN(this.bufferSize)||this.bufferSize<1)throw RangeError(`Invalid buffer size: ${e?.bufferSize}`);this.#i=new Uint16Array(this.bufferSize)}decode(t,e){let n=Boolean(e?.stream),r=Pr(t),i=[],s=this.#i,o=this.bufferSize-3,a=0,f=()=>{if(this.#e=0,this.#t=0,this.#n=0,this.fatal)throw new Zt;s[a++]=wn},h=()=>{let u=this.#n;for(let d=0;d<u;d++)f()},l=(u)=>{if(this.#t===0)switch(kr[u>>4]){case-1:f();break;case 0:s[a++]=u;break;case 1:if(this.#e=u&31,(this.#e&30)===0)f();else this.#t=1,this.#n=1;break;case 2:this.#e=u&15,this.#t=2,this.#n=1;break;case 3:if(u&8)f();else this.#e=u&7,this.#t=3,this.#n=1;break}else{if((u&192)!==128)return h(),l(u);if(this.#n===1&&this.#t===2&&this.#e===0&&(u&32)===0)return h(),l(u);if(this.#t===3&&this.#e===0&&(u&48)===0)return h(),l(u);if(this.#e=this.#e<<6|u&63,this.#n++,--this.#t===0){if(this.ignoreBOM||!this.#r||this.#e!==ln)if(this.#e<65536)s[a++]=this.#e;else{let d=this.#e-65536;s[a++]=d>>>10&1023|Vt,s[a++]=d&1023|mn}this.#e=0,this.#n=0,this.#r=!1}}};for(let u of r){if(a>=o)i.push(String.fromCharCode.apply(null,s.subarray(0,a))),a=0;l(u)}if(!n){if(this.#r=!0,this.#e||this.#t)h()}if(a>0)i.push(String.fromCharCode.apply(null,s.subarray(0,a)));return i.join("")}}function Kr(t){let e=0;for(let n of t){let r=n.codePointAt(0);if(r<128)e++;else if(r<2048)e+=2;else if(r<65536)e+=3;else e+=4}return e}class ft{encoding=Yt;encode(t){if(!t)return Jt;let e=new Uint8Array(Kr(String(t)));return this.encodeInto(t,e),e}encodeInto(t,e){let n=String(t),r=n.length,i=e.length,s=0,o=0;for(o=0;o<r;o++){let a=n.codePointAt(o);if(a<128){if(s>=i)break;e[s++]=a}else if(a<2048){if(s>=i-1)break;e[s++]=192|a>>6,e[s++]=128|a&63}else if(a<65536){if(s>=i-2)break;e[s++]=224|a>>12,e[s++]=128|a>>6&63,e[s++]=128|a&63}else{if(s>=i-3)break;e[s++]=240|a>>18,e[s++]=128|a>>12&63,e[s++]=128|a>>6&63,e[s++]=128|a&63,o++}}return{read:o,written:s}}}class gn{#t;#e;constructor(t="wtf-8",e=void 0){let n=new W(t,e);this.#t=n,this.#e=new TransformStream({transform(r,i){let s=n.decode(r,{stream:!0});if(s)i.enqueue(s)},flush(r){let i=n.decode();if(i)r.enqueue(i);r.terminate()}})}get encoding(){return this.#t.encoding}get fatal(){return this.#t.fatal}get ignoreBOM(){return this.#t.ignoreBOM}get readable(){return this.#e.readable}get writable(){return this.#e.writable}}function Lr(t){return Vt<=t&&t<=un}class dn{#t=null;#e;#n;constructor(){this.#e=new ft,this.#n=new TransformStream({transform:(t,e)=>{if(t=String(t),this.#t!=null)t=this.#t+t,this.#t=null;if(Lr(t.charCodeAt(t.length-1)))this.#t=t[t.length-1],t=t.slice(0,-1);if(t){let n=this.#e.encode(t);if(n.length)e.enqueue(n)}},flush:(t)=>{if(this.#t!==null)t.enqueue(this.#e.encode(this.#t)),this.#t=null}})}get encoding(){return this.#e.encoding}get readable(){return this.#n.readable}get writable(){return this.#n.writable}}var yn=c.SIMPLE_FLOAT<<5|w.TWO,Fr=c.SIMPLE_FLOAT<<5|w.FOUR,Br=c.SIMPLE_FLOAT<<5|w.EIGHT,$r=c.SIMPLE_FLOAT<<5|K.TRUE,Gr=c.SIMPLE_FLOAT<<5|K.FALSE,Rr=c.SIMPLE_FLOAT<<5|K.UNDEFINED,jr=c.SIMPLE_FLOAT<<5|K.NULL,zr=new TextEncoder,Hr=new ft,te={...at.defaultOptions,avoidInts:!1,cde:!1,collapseBigInts:!0,dcbor:!1,float64:!1,flushToZero:!1,forceEndian:null,ignoreOriginalEncoding:!1,largeNegativeAsBigInt:!1,reduceUnsafeNumbers:!1,rejectBigInts:!1,rejectCustomSimples:!1,rejectDuplicateKeys:!1,rejectFloats:!1,rejectUndefined:!1,simplifyNegativeZero:!1,sortKeys:null,stringNormalization:null,types:null,wtf8:!1},Ie={cde:!0,ignoreOriginalEncoding:!0,sortKeys:Ct},En={...Ie,dcbor:!0,largeNegativeAsBigInt:!0,reduceUnsafeNumbers:!0,rejectCustomSimples:!0,rejectDuplicateKeys:!0,rejectUndefined:!0,simplifyNegativeZero:!0,stringNormalization:"NFC"};function pn(t){let e=t<0;return typeof t=="bigint"?[e?-t-1n:t,e]:[e?-t-1:t,e]}function De(t,e,n){if(n.rejectFloats)throw Error(`Attempt to encode an unwanted floating point number: ${t}`);if(isNaN(t))e.writeUint8(yn),e.writeUint16(32256);else if(!n.float64&&Math.fround(t)===t){let r=Xt(t);r===null?(e.writeUint8(Fr),e.writeFloat32(t)):(e.writeUint8(yn),e.writeUint16(r))}else e.writeUint8(Br),e.writeFloat64(t)}function I(t,e,n){let[r,i]=pn(t);if(i&&n)throw TypeError(`Negative size: ${t}`);n??=i?c.NEG_INT:c.POS_INT,n<<=5,r<24?e.writeUint8(n|r):r<=255?(e.writeUint8(n|w.ONE),e.writeUint8(r)):r<=65535?(e.writeUint8(n|w.TWO),e.writeUint16(r)):r<=4294967295?(e.writeUint8(n|w.FOUR),e.writeUint32(r)):(e.writeUint8(n|w.EIGHT),e.writeBigUint64(BigInt(r)))}function ct(t,e,n){typeof t=="number"?I(t,e,c.TAG):typeof t=="object"&&!n.ignoreOriginalEncoding&&(E.ENCODED in t)?e.write(t[E.ENCODED]):t<=Number.MAX_SAFE_INTEGER?I(Number(t),e,c.TAG):(e.writeUint8(c.TAG<<5|w.EIGHT),e.writeBigUint64(BigInt(t)))}function bn(t,e,n){let[r,i]=pn(t);if(n.collapseBigInts&&(!n.largeNegativeAsBigInt||t>=-0x8000000000000000n)){if(r<=0xffffffffn){I(Number(t),e);return}if(r<=0xffffffffffffffffn){let h=(i?c.NEG_INT:c.POS_INT)<<5;e.writeUint8(h|w.EIGHT),e.writeBigUint64(r);return}}if(n.rejectBigInts)throw Error(`Attempt to encode unwanted bigint: ${t}`);let s=i?g.NEG_BIGINT:g.POS_BIGINT,o=r.toString(16),a=o.length%2?"0":"";ct(s,e,n);let f=qt(a+o);I(f.length,e,c.BYTE_STRING),e.write(f)}function qr(t,e,n){n.flushToZero&&(t=cn(t)),Object.is(t,-0)?n.simplifyNegativeZero?n.avoidInts?De(0,e,n):I(0,e):De(t,e,n):!n.avoidInts&&Number.isSafeInteger(t)?I(t,e):n.reduceUnsafeNumbers&&Math.floor(t)===t&&t>=ot.MIN&&t<=ot.MAX?bn(BigInt(t),e,n):De(t,e,n)}function Wr(t,e,n){let r=n.stringNormalization?t.normalize(n.stringNormalization):t;if(n.wtf8&&!t.isWellFormed()){let i=Hr.encode(r);ct(g.WTF8,e,n),I(i.length,e,c.BYTE_STRING),e.write(i)}else{let i=zr.encode(r);I(i.length,e,c.UTF8_STRING),e.write(i)}}function Cr(t,e,n){let r=t;ee(r,r.length,c.ARRAY,e,n);for(let i of r)C(i,e,n)}function Xr(t,e){I(t.length,e,c.BYTE_STRING),e.write(t)}var Qt=new Wt;Qt.registerEncoder(Array,Cr),Qt.registerEncoder(Uint8Array,Xr);function p(t,e){return Qt.registerEncoder(t,e)}function ee(t,e,n,r,i){let s=rn(t);s&&!i.ignoreOriginalEncoding?r.write(s):I(e,r,n)}function Zr(t,e,n){if(t===null){e.writeUint8(jr);return}if(!n.ignoreOriginalEncoding&&E.ENCODED in t){e.write(t[E.ENCODED]);return}let r=t.constructor;if(r){let s=n.types?.get(r)??Qt.get(r);if(s){let o=s(t,e,n);if(o!==void 0){if(!Array.isArray(o)||o.length!==2)throw Error("Invalid encoder return value");(typeof o[0]=="bigint"||isFinite(Number(o[0])))&&ct(o[0],e,n),C(o[1],e,n)}return}}if(typeof t.toCBOR=="function"){let s=t.toCBOR(e,n);s&&((typeof s[0]=="bigint"||isFinite(Number(s[0])))&&ct(s[0],e,n),C(s[1],e,n));return}if(typeof t.toJSON=="function"){C(t.toJSON(),e,n);return}let i=Object.entries(t).map((s)=>[s[0],s[1],y(s[0],n)]);n.sortKeys&&i.sort(n.sortKeys),ee(t,i.length,c.MAP,e,n);for(let[s,o,a]of i)e.write(a),C(o,e,n)}function C(t,e,n){switch(typeof t){case"number":qr(t,e,n);break;case"bigint":bn(t,e,n);break;case"string":Wr(t,e,n);break;case"boolean":e.writeUint8(t?$r:Gr);break;case"undefined":if(n.rejectUndefined)throw Error("Attempt to encode unwanted undefined.");e.writeUint8(Rr);break;case"object":Zr(t,e,n);break;case"symbol":throw TypeError(`Unknown symbol: ${t.toString()}`);default:throw TypeError(`Unknown type: ${typeof t}, ${String(t)}`)}}function y(t,e={}){let n={...te};e.dcbor?Object.assign(n,En):e.cde&&Object.assign(n,Ie),Object.assign(n,e);let r=new at(n);return C(t,r,n),r.read()}var tt=((t)=>(t[t.NEVER=-1]="NEVER",t[t.PREFERRED=0]="PREFERRED",t[t.ALWAYS=1]="ALWAYS",t))(tt||{});class D{static KnownSimple=new Map([[K.FALSE,!1],[K.TRUE,!0],[K.NULL,null],[K.UNDEFINED,void 0]]);value;constructor(t){this.value=t}static create(t){return D.KnownSimple.has(t)?D.KnownSimple.get(t):new D(t)}toCBOR(t,e){if(e.rejectCustomSimples)throw Error(`Cannot encode non-standard Simple value: ${this.value}`);I(this.value,t,c.SIMPLE_FLOAT)}toString(){return`simple(${this.value})`}decode(){return D.KnownSimple.has(this.value)?D.KnownSimple.get(this.value):this}[Symbol.for("nodejs.util.inspect.custom")](t,e,n){return`simple(${n(this.value,e)})`}}var Jr=new TextDecoder("utf8",{fatal:!0,ignoreBOM:!0});class P{static defaultOptions={maxDepth:1024,encoding:"hex",requirePreferred:!1};#t;#e;#n=0;#r;constructor(t,e){if(this.#r={...P.defaultOptions,...e},typeof t=="string")switch(this.#r.encoding){case"hex":this.#t=qt(t);break;case"base64":this.#t=Ut(t);break;default:throw TypeError(`Encoding not implemented: "${this.#r.encoding}"`)}else this.#t=t;this.#e=new DataView(this.#t.buffer,this.#t.byteOffset,this.#t.byteLength)}toHere(t){return _t(this.#t,t,this.#n)}*[Symbol.iterator](){if(yield*this.#i(0),this.#n!==this.#t.length)throw Error("Extra data in input")}*seq(){for(;this.#n<this.#t.length;)yield*this.#i(0)}*#i(t){if(t++>this.#r.maxDepth)throw Error(`Maximum depth ${this.#r.maxDepth} exceeded`);let e=this.#n,n=this.#e.getUint8(this.#n++),r=n>>5,i=n&31,s=i,o=!1,a=0;switch(i){case w.ONE:if(a=1,s=this.#e.getUint8(this.#n),r===c.SIMPLE_FLOAT){if(s<32)throw Error(`Invalid simple encoding in extra byte: ${s}`);o=!0}else if(this.#r.requirePreferred&&s<24)throw Error(`Unexpectedly long integer encoding (1) for ${s}`);break;case w.TWO:if(a=2,r===c.SIMPLE_FLOAT)s=Te(this.#t,this.#n);else if(s=this.#e.getUint16(this.#n,!1),this.#r.requirePreferred&&s<=255)throw Error(`Unexpectedly long integer encoding (2) for ${s}`);break;case w.FOUR:if(a=4,r===c.SIMPLE_FLOAT)s=this.#e.getFloat32(this.#n,!1);else if(s=this.#e.getUint32(this.#n,!1),this.#r.requirePreferred&&s<=65535)throw Error(`Unexpectedly long integer encoding (4) for ${s}`);break;case w.EIGHT:{if(a=8,r===c.SIMPLE_FLOAT)s=this.#e.getFloat64(this.#n,!1);else if(s=this.#e.getBigUint64(this.#n,!1),s<=Number.MAX_SAFE_INTEGER&&(s=Number(s)),this.#r.requirePreferred&&s<=4294967295)throw Error(`Unexpectedly long integer encoding (8) for ${s}`);break}case 28:case 29:case 30:throw Error(`Additional info not implemented: ${i}`);case w.INDEFINITE:switch(r){case c.POS_INT:case c.NEG_INT:case c.TAG:throw Error(`Invalid indefinite encoding for MT ${r}`);case c.SIMPLE_FLOAT:yield[r,i,E.BREAK,e,0];return}s=1/0;break;default:o=!0}switch(this.#n+=a,r){case c.POS_INT:yield[r,i,s,e,a];break;case c.NEG_INT:yield[r,i,typeof s=="bigint"?-1n-s:-1-Number(s),e,a];break;case c.BYTE_STRING:s===1/0?yield*this.#o(r,t,e):yield[r,i,this.#s(s),e,s];break;case c.UTF8_STRING:s===1/0?yield*this.#o(r,t,e):yield[r,i,Jr.decode(this.#s(s)),e,s];break;case c.ARRAY:if(s===1/0)yield*this.#o(r,t,e,!1);else{let f=Number(s);yield[r,i,f,e,a];for(let h=0;h<f;h++)yield*this.#i(t+1)}break;case c.MAP:if(s===1/0)yield*this.#o(r,t,e,!1);else{let f=Number(s);yield[r,i,f,e,a];for(let h=0;h<f;h++)yield*this.#i(t),yield*this.#i(t)}break;case c.TAG:yield[r,i,s,e,a],yield*this.#i(t);break;case c.SIMPLE_FLOAT:{let f=s;o&&(s=D.create(Number(s))),yield[r,i,s,e,f];break}}}#s(t){let e=_t(this.#t,this.#n,this.#n+=t);if(e.length!==t)throw Error(`Unexpected end of stream reading ${t} bytes, got ${e.length}`);return e}*#o(t,e,n,r=!0){for(yield[t,w.INDEFINITE,1/0,n,1/0];;){let i=this.#i(e),s=i.next(),[o,a,f]=s.value;if(f===E.BREAK){yield s.value,i.next();return}if(r){if(o!==t)throw Error(`Unmatched major type.  Expected ${t}, got ${o}.`);if(a===w.INDEFINITE)throw Error("New stream started in typed stream")}yield s.value,yield*i}}}var Vr=new Map([[w.ZERO,1],[w.ONE,2],[w.TWO,3],[w.FOUR,5],[w.EIGHT,9]]),Yr=new Uint8Array(0);function Qr(t,e){return!e.boxed&&!e.preferMap&&t.every(([n])=>typeof n=="string")?Object.fromEntries(t):new Map(t)}class x{static defaultDecodeOptions={...P.defaultOptions,ParentType:x,boxed:!1,cde:!1,dcbor:!1,diagnosticSizes:tt.PREFERRED,convertUnsafeIntsToFloat:!1,createObject:Qr,pretty:!1,preferMap:!1,rejectLargeNegatives:!1,rejectBigInts:!1,rejectDuplicateKeys:!1,rejectFloats:!1,rejectInts:!1,rejectLongLoundNaN:!1,rejectLongFloats:!1,rejectNegativeZero:!1,rejectSimple:!1,rejectStreaming:!1,rejectStringsNotNormalizedAs:null,rejectSubnormals:!1,rejectUndefined:!1,rejectUnsafeFloatInts:!1,saveOriginal:!1,sortKeys:null,tags:null};static cdeDecodeOptions={cde:!0,rejectStreaming:!0,requirePreferred:!0,sortKeys:Ct};static dcborDecodeOptions={...this.cdeDecodeOptions,dcbor:!0,convertUnsafeIntsToFloat:!0,rejectDuplicateKeys:!0,rejectLargeNegatives:!0,rejectLongLoundNaN:!0,rejectLongFloats:!0,rejectNegativeZero:!0,rejectSimple:!0,rejectUndefined:!0,rejectUnsafeFloatInts:!0,rejectStringsNotNormalizedAs:"NFC"};parent;mt;ai;left;offset;count=0;children=[];depth=0;#t;#e=null;constructor(t,e,n,r){if([this.mt,this.ai,,this.offset]=t,this.left=e,this.parent=n,this.#t=r,n&&(this.depth=n.depth+1),this.mt===c.MAP&&(this.#t.sortKeys||this.#t.rejectDuplicateKeys)&&(this.#e=[]),this.#t.rejectStreaming&&this.ai===w.INDEFINITE)throw Error("Streaming not supported")}get isStreaming(){return this.left===1/0}get done(){return this.left===0}static create(t,e,n,r){let[i,s,o,a]=t;switch(i){case c.POS_INT:case c.NEG_INT:{if(n.rejectInts)throw Error(`Unexpected integer: ${o}`);if(n.rejectLargeNegatives&&o<-0x8000000000000000n)throw Error(`Invalid 65bit negative number: ${o}`);let f=o;return n.convertUnsafeIntsToFloat&&f>=ot.MIN&&f<=ot.MAX&&(f=Number(o)),n.boxed?q(f,r.toHere(a)):f}case c.SIMPLE_FLOAT:if(s>w.ONE){if(n.rejectFloats)throw Error(`Decoding unwanted floating point number: ${o}`);if(n.rejectNegativeZero&&Object.is(o,-0))throw Error("Decoding negative zero");if(n.rejectLongLoundNaN&&isNaN(o)){let f=r.toHere(a);if(f.length!==3||f[1]!==126||f[2]!==0)throw Error(`Invalid NaN encoding: "${A(f)}"`)}if(n.rejectSubnormals&&hn(r.toHere(a+1)),n.rejectLongFloats){let f=y(o,{chunkSize:9,reduceUnsafeNumbers:n.rejectUnsafeFloatInts});if(f[0]>>5!==i)throw Error(`Should have been encoded as int, not float: ${o}`);if(f.length<Vr.get(s))throw Error(`Number should have been encoded shorter: ${o}`)}if(typeof o=="number"&&n.boxed)return q(o,r.toHere(a))}else{if(n.rejectSimple&&o instanceof D)throw Error(`Invalid simple value: ${o}`);if(n.rejectUndefined&&o===void 0)throw Error("Unexpected undefined")}return o;case c.BYTE_STRING:case c.UTF8_STRING:if(o===1/0)return new n.ParentType(t,1/0,e,n);if(n.rejectStringsNotNormalizedAs&&typeof o=="string"){let f=o.normalize(n.rejectStringsNotNormalizedAs);if(o!==f)throw Error(`String not normalized as "${n.rejectStringsNotNormalizedAs}", got [${Ae(o)}] instead of [${Ae(f)}]`)}return n.boxed?q(o,r.toHere(a)):o;case c.ARRAY:return new n.ParentType(t,o,e,n);case c.MAP:return new n.ParentType(t,o*2,e,n);case c.TAG:{let f=new n.ParentType(t,1,e,n);return f.children=new m(o),f}}throw TypeError(`Invalid major type: ${i}`)}static decodeToEncodeOpts(t){return{...te,avoidInts:t.rejectInts,float64:!t.rejectLongFloats,flushToZero:t.rejectSubnormals,largeNegativeAsBigInt:t.rejectLargeNegatives,sortKeys:t.sortKeys}}push(t,e,n){if(this.children.push(t),this.#e){let r=z(t)||e.toHere(n);this.#e.push(r)}return--this.left}replaceLast(t,e,n){let r,i=-1/0;if(this.children instanceof m?(i=0,r=this.children.contents,this.children.contents=t):(i=this.children.length-1,r=this.children[i],this.children[i]=t),this.#e){let s=z(t)||n.toHere(e.offset);this.#e[i]=s}return r}convert(t){let e;switch(this.mt){case c.ARRAY:e=this.children;break;case c.MAP:{let n=this.#n();if(this.#t.sortKeys){let r;for(let i of n){if(r&&this.#t.sortKeys(r,i)>=0)throw Error(`Duplicate or out of order key: "0x${i[2]}"`);r=i}}else if(this.#t.rejectDuplicateKeys){let r=new Set;for(let[i,s,o]of n){let a=A(o);if(r.has(a))throw Error(`Duplicate key: "0x${a}"`);r.add(a)}}e=this.#t.createObject(n,this.#t);break}case c.BYTE_STRING:return on(this.children);case c.UTF8_STRING:{let n=this.children.join("");e=this.#t.boxed?q(n,t.toHere(this.offset)):n;break}case c.TAG:e=this.children.decode(this.#t);break;default:throw TypeError(`Invalid mt on convert: ${this.mt}`)}return this.#t.saveOriginal&&e&&typeof e=="object"&&H(e,t.toHere(this.offset)),e}#n(){let t=this.children,e=t.length;if(e%2)throw Error("Missing map value");let n=Array(e/2);if(this.#e)for(let r=0;r<e;r+=2)n[r>>1]=[t[r],t[r+1],this.#e[r]];else for(let r=0;r<e;r+=2)n[r>>1]=[t[r],t[r+1],Yr];return n}}var _e="  ",ti=new TextEncoder;class Ue extends x{close="";quote='"';get isEmptyStream(){return(this.mt===c.UTF8_STRING||this.mt===c.BYTE_STRING)&&this.count===0}}function X(t,e,n,r){let i="";if(e===w.INDEFINITE)i+="_";else{if(r.diagnosticSizes===tt.NEVER)return"";{let s=r.diagnosticSizes===tt.ALWAYS;if(!s){let o=w.ZERO;if(Object.is(n,-0))o=w.TWO;else if(t===c.POS_INT||t===c.NEG_INT){let a=n<0,f=typeof n=="bigint"?1n:1,h=a?-n-f:n;h<=23?o=Number(h):h<=255?o=w.ONE:h<=65535?o=w.TWO:h<=4294967295?o=w.FOUR:o=w.EIGHT}else isFinite(n)?Math.fround(n)===n?Xt(n)==null?o=w.FOUR:o=w.TWO:o=w.EIGHT:o=w.TWO;s=o!==e}s&&(i+="_",e<w.ONE?i+="i":i+=String(e-24))}}return i}function vt(t,e){let n={...x.defaultDecodeOptions,...e,ParentType:Ue},r=new P(t,n),i,s,o="";for(let a of r){let[f,h,l]=a;switch(i&&(i.count>0&&l!==E.BREAK&&(i.mt===c.MAP&&i.count%2?o+=": ":(o+=",",n.pretty||(o+=" "))),n.pretty&&(i.mt!==c.MAP||i.count%2===0)&&(o+=`
${_e.repeat(i.depth+1)}`)),s=x.create(a,i,n,r),f){case c.POS_INT:case c.NEG_INT:o+=String(l),o+=X(f,h,l,n);break;case c.SIMPLE_FLOAT:if(l!==E.BREAK)if(typeof l=="number"){let u=Object.is(l,-0)?"-0.0":String(l);o+=u,isFinite(l)&&!/[.e]/.test(u)&&(o+=".0"),o+=X(f,h,l,n)}else l instanceof D?(o+="simple(",o+=String(l.value),o+=X(c.POS_INT,h,l.value,n),o+=")"):o+=String(l);break;case c.BYTE_STRING:l===1/0?(o+="(_ ",s.close=")",s.quote="'"):(o+="h'",o+=A(l),o+="'",o+=X(c.POS_INT,h,l.length,n));break;case c.UTF8_STRING:l===1/0?(o+="(_ ",s.close=")"):(o+=JSON.stringify(l),o+=X(c.POS_INT,h,ti.encode(l).length,n));break;case c.ARRAY:{o+="[";let u=X(c.POS_INT,h,l,n);o+=u,u&&(o+=" "),n.pretty&&l?s.close=`
${_e.repeat(s.depth)}]`:s.close="]";break}case c.MAP:{o+="{";let u=X(c.POS_INT,h,l,n);o+=u,u&&(o+=" "),n.pretty&&l?s.close=`
${_e.repeat(s.depth)}}`:s.close="}";break}case c.TAG:o+=String(l),o+=X(c.POS_INT,h,l,n),o+="(",s.close=")";break}if(s===E.BREAK)if(i?.isStreaming)i.left=0;else throw Error("Unexpected BREAK");else i&&(i.count++,i.left--);for(s instanceof Ue&&(i=s);i?.done;){if(i.isEmptyStream)o=o.slice(0,-3),o+=`${i.quote}${i.quote}_`;else{if(i.mt===c.MAP&&i.count%2!==0)throw Error(`Odd streaming map size: ${i.count}`);o+=i.close}i=i.parent}}return o}var ei=new TextDecoder;class re extends x{depth=0;leaf=!1;value;length;[E.ENCODED];constructor(t,e,n,r){super(t,e,n,r),this.parent?this.depth=this.parent.depth+1:this.depth=r.initialDepth,[,,this.value,,this.length]=t}numBytes(){switch(this.ai){case w.ONE:return 1;case w.TWO:return 2;case w.FOUR:return 4;case w.EIGHT:return 8}return 0}}function xn(t){return t instanceof re}function ne(t,e){return t===1/0?"Indefinite":e?`${t} ${e}${t!==1&&t!==1n?"s":""}`:String(t)}function Ot(t){return"".padStart(t," ")}function Nn(t,e,n){let r="";r+=Ot(t.depth*2);let i=z(t);r+=A(i.subarray(0,1));let s=t.numBytes();s&&(r+=" ",r+=A(i.subarray(1,s+1))),r=r.padEnd(e.minCol+1," "),r+="-- ",n!==void 0&&(r+=Ot(t.depth*2),n!==""&&(r+=`[${n}] `));let o=!1,[a]=t.children;switch(t.mt){case c.POS_INT:r+=`Unsigned: ${a}`,typeof a=="bigint"&&(r+="n");break;case c.NEG_INT:r+=`Negative: ${a}`,typeof a=="bigint"&&(r+="n");break;case c.BYTE_STRING:r+=`Bytes (Length: ${ne(t.length)})`;break;case c.UTF8_STRING:r+=`UTF8 (Length: ${ne(t.length)})`,t.length!==1/0&&(r+=`: ${JSON.stringify(a)}`);break;case c.ARRAY:r+=`Array (Length: ${ne(t.value,"item")})`;break;case c.MAP:r+=`Map (Length: ${ne(t.value,"pair")})`;break;case c.TAG:{r+=`Tag #${t.value}`;let f=t.children,[h]=f.contents.children,l=new m(f.tag,h);H(l,i);let u=l.comment(e,t.depth);u&&(r+=": ",r+=u),o||=l.noChildren;break}case c.SIMPLE_FLOAT:a===E.BREAK?r+="BREAK":t.ai>w.ONE?Object.is(a,-0)?r+="Float: -0":r+=`Float: ${a}`:(r+="Simple: ",a instanceof D?r+=a.value:r+=a);break}if(!o)if(t.leaf){if(r+=`
`,i.length>s+1){let f=Ot((t.depth+1)*2),h=It(i);if(h?.length){h.sort((u,d)=>{return u[0]-d[0]||d[1]-u[1]});let l=0;for(let[u,d,F]of h)if(!(u<l)){if(l=u+d,F==="<<"){r+=Ot(e.minCol+1),r+="--",r+=f,r+="<< ";let v=_t(i,u,u+d),Q=It(v);if(Q){let Ft=Q.findIndex(([he,le,er])=>he===0&&le===d&&er==="<<");Ft>=0&&Q.splice(Ft,1)}r+=vt(v),r+=` >>
`,r+=ie(v,{initialDepth:t.depth+1,minCol:e.minCol,noPrefixHex:!0});continue}else F==="'"&&(r+=Ot(e.minCol+1),r+="--",r+=f,r+="'",r+=ei.decode(i.subarray(u,u+d)),r+=`'
`);if(u>s)for(let v=u;v<u+d;v+=8){let Q=Math.min(v+8,u+d);r+=f,r+=A(i.subarray(v,Q)),r+=`
`}}}else for(let l=s+1;l<i.length;l+=8)r+=f,r+=A(i.subarray(l,l+8)),r+=`
`}}else{r+=`
`;let f=0;for(let h of t.children){if(xn(h)){let l=String(f);t.mt===c.MAP?l=f%2?`val ${(f-1)/2}`:`key ${f/2}`:t.mt===c.TAG&&(l=""),r+=Nn(h,e,l)}f++}}return r}var ni={...x.defaultDecodeOptions,initialDepth:0,noPrefixHex:!1,minCol:0};function ie(t,e){let n={...ni,...e,ParentType:re,saveOriginal:!0},r=new P(t,n),i,s;for(let a of r){if(s=x.create(a,i,n,r),a[2]===E.BREAK)if(i?.isStreaming)i.left=1;else throw Error("Unexpected BREAK");if(!xn(s)){let l=new re(a,0,i,n);l.leaf=!0,l.children.push(s),H(l,r.toHere(a[3])),s=l}let f=(s.depth+1)*2,h=s.numBytes();for(h&&(f+=1,f+=h*2),n.minCol=Math.max(n.minCol,f),i&&i.push(s,r,a[3]),i=s;i?.done;)s=i,s.leaf||H(s,r.toHere(s.offset)),{parent:i}=i}e&&(e.minCol=n.minCol);let o=n.noPrefixHex?"":`0x${A(r.toHere(0))}
`;return o+=Nn(s,n),o}var An=!fn();function Un(t){if(typeof t=="object"&&t){if(t.constructor!==Number)throw Error(`Expected number: ${t}`)}else if(typeof t!="number")throw Error(`Expected number: ${t}`)}function J(t){if(typeof t=="object"&&t){if(t.constructor!==String)throw Error(`Expected string: ${t}`)}else if(typeof t!="string")throw Error(`Expected string: ${t}`)}function $(t){if(!(t instanceof Uint8Array))throw Error(`Expected Uint8Array: ${t}`)}function vn(t){if(!Array.isArray(t))throw Error(`Expected Array: ${t}`)}p(Map,(t,e,n)=>{let r=[...t.entries()].map((i)=>[i[0],i[1],y(i[0],n)]);if(n.rejectDuplicateKeys){let i=new Set;for(let[s,o,a]of r){let f=A(a);if(i.has(f))throw Error(`Duplicate map key: 0x${f}`);i.add(f)}}n.sortKeys&&r.sort(n.sortKeys),ee(t,t.size,c.MAP,e,n);for(let[i,s,o]of r)e.write(o),C(s,e,n)});function Tn(t){return J(t.contents),new Date(t.contents)}Tn.comment=(t)=>(J(t.contents),`(String Date) ${new Date(t.contents).toISOString()}`),m.registerDecoder(g.DATE_STRING,Tn);function Sn(t){return Un(t.contents),new Date(t.contents*1000)}Sn.comment=(t)=>(Un(t.contents),`(Epoch Date) ${new Date(t.contents*1000).toISOString()}`),m.registerDecoder(g.DATE_EPOCH,Sn),p(Date,(t)=>[g.DATE_EPOCH,t.valueOf()/1000]);function oe(t,e,n){if($(e.contents),n.rejectBigInts)throw Error(`Decoding unwanted big integer: ${e}(h'${A(e.contents)}')`);if(n.requirePreferred&&e.contents[0]===0)throw Error(`Decoding overly-large bigint: ${e.tag}(h'${A(e.contents)})`);let r=e.contents.reduce((i,s)=>i<<8n|BigInt(s),0n);if(t&&(r=-1n-r),n.requirePreferred&&r>=Number.MIN_SAFE_INTEGER&&r<=Number.MAX_SAFE_INTEGER)throw Error(`Decoding bigint that could have been int: ${r}n`);return n.boxed?q(r,e.contents):r}var Dn=oe.bind(null,!1),In=oe.bind(null,!0);Dn.comment=(t,e)=>`(Positive BigInt) ${oe(!1,t,e)}n`,In.comment=(t,e)=>`(Negative BigInt) ${oe(!0,t,e)}n`,m.registerDecoder(g.POS_BIGINT,Dn),m.registerDecoder(g.NEG_BIGINT,In);function ve(t,e){return $(t.contents),t}ve.comment=(t,e,n)=>{$(t.contents);let r={...e,initialDepth:n+2,noPrefixHex:!0},i=z(t),s=2**((i[0]&31)-24)+1,o=i[s]&31,a=A(i.subarray(s,++s));o>=24&&(a+=" ",a+=A(i.subarray(s,s+2**(o-24)))),r.minCol=Math.max(r.minCol,(n+1)*2+a.length);let f=ie(t.contents,r),h=`Embedded CBOR
`;return h+=`${"".padStart((n+1)*2," ")}${a}`.padEnd(r.minCol+1," "),h+=`-- Bytes (Length: ${t.contents.length})
`,h+=f,h},ve.noChildren=!0,m.registerDecoder(g.CBOR,ve),m.registerDecoder(g.URI,(t)=>(J(t.contents),new URL(t.contents)),"URI"),p(URL,(t)=>[g.URI,t.toString()]),m.registerDecoder(g.BASE64URL,(t)=>(J(t.contents),an(t.contents)),"Base64url-encoded"),m.registerDecoder(g.BASE64,(t)=>(J(t.contents),Ut(t.contents)),"Base64-encoded"),m.registerDecoder(35,(t)=>(J(t.contents),new RegExp(t.contents)),"RegExp"),m.registerDecoder(21065,(t)=>{J(t.contents);let e=`^(?:${t.contents})$`;return new RegExp(e,"u")},"I-RegExp"),m.registerDecoder(g.REGEXP,(t)=>{if(vn(t.contents),t.contents.length<1||t.contents.length>2)throw Error(`Invalid RegExp Array: ${t.contents}`);return new RegExp(t.contents[0],t.contents[1])},"RegExp"),p(RegExp,(t)=>[g.REGEXP,[t.source,t.flags]]),m.registerDecoder(64,(t)=>($(t.contents),t.contents),"uint8 Typed Array");function S(t,e,n){$(t.contents);let r=t.contents.length;if(r%e.BYTES_PER_ELEMENT!==0)throw Error(`Number of bytes must be divisible by ${e.BYTES_PER_ELEMENT}, got: ${r}`);r/=e.BYTES_PER_ELEMENT;let i=new e(r),s=new DataView(t.contents.buffer,t.contents.byteOffset,t.contents.byteLength),o=s[`get${e.name.replace(/Array/,"")}`].bind(s);for(let a=0;a<r;a++)i[a]=o(a*e.BYTES_PER_ELEMENT,n);return i}function Z(t,e,n,r,i){let s=i.forceEndian??An;if(ct(s?e:n,t,i),I(r.byteLength,t,c.BYTE_STRING),An===s)t.write(new Uint8Array(r.buffer,r.byteOffset,r.byteLength));else{let o=`write${r.constructor.name.replace(/Array/,"")}`,a=t[o].bind(t);for(let f of r)a(f,s)}}m.registerDecoder(65,(t)=>S(t,Uint16Array,!1),"uint16, big endian, Typed Array"),m.registerDecoder(66,(t)=>S(t,Uint32Array,!1),"uint32, big endian, Typed Array"),m.registerDecoder(67,(t)=>S(t,BigUint64Array,!1),"uint64, big endian, Typed Array"),m.registerDecoder(68,(t)=>($(t.contents),new Uint8ClampedArray(t.contents)),"uint8 Typed Array, clamped arithmetic"),p(Uint8ClampedArray,(t)=>[68,new Uint8Array(t.buffer,t.byteOffset,t.byteLength)]),m.registerDecoder(69,(t)=>S(t,Uint16Array,!0),"uint16, little endian, Typed Array"),p(Uint16Array,(t,e,n)=>Z(e,69,65,t,n)),m.registerDecoder(70,(t)=>S(t,Uint32Array,!0),"uint32, little endian, Typed Array"),p(Uint32Array,(t,e,n)=>Z(e,70,66,t,n)),m.registerDecoder(71,(t)=>S(t,BigUint64Array,!0),"uint64, little endian, Typed Array"),p(BigUint64Array,(t,e,n)=>Z(e,71,67,t,n)),m.registerDecoder(72,(t)=>($(t.contents),new Int8Array(t.contents)),"sint8 Typed Array"),p(Int8Array,(t)=>[72,new Uint8Array(t.buffer,t.byteOffset,t.byteLength)]),m.registerDecoder(73,(t)=>S(t,Int16Array,!1),"sint16, big endian, Typed Array"),m.registerDecoder(74,(t)=>S(t,Int32Array,!1),"sint32, big endian, Typed Array"),m.registerDecoder(75,(t)=>S(t,BigInt64Array,!1),"sint64, big endian, Typed Array"),m.registerDecoder(77,(t)=>S(t,Int16Array,!0),"sint16, little endian, Typed Array"),p(Int16Array,(t,e,n)=>Z(e,77,73,t,n)),m.registerDecoder(78,(t)=>S(t,Int32Array,!0),"sint32, little endian, Typed Array"),p(Int32Array,(t,e,n)=>Z(e,78,74,t,n)),m.registerDecoder(79,(t)=>S(t,BigInt64Array,!0),"sint64, little endian, Typed Array"),p(BigInt64Array,(t,e,n)=>Z(e,79,75,t,n)),m.registerDecoder(81,(t)=>S(t,Float32Array,!1),"IEEE 754 binary32, big endian, Typed Array"),m.registerDecoder(82,(t)=>S(t,Float64Array,!1),"IEEE 754 binary64, big endian, Typed Array"),m.registerDecoder(85,(t)=>S(t,Float32Array,!0),"IEEE 754 binary32, little endian, Typed Array"),p(Float32Array,(t,e,n)=>Z(e,85,81,t,n)),m.registerDecoder(86,(t)=>S(t,Float64Array,!0),"IEEE 754 binary64, big endian, Typed Array"),p(Float64Array,(t,e,n)=>Z(e,86,82,t,n)),m.registerDecoder(g.SET,(t,e)=>{if(vn(t.contents),e.sortKeys){let n=x.decodeToEncodeOpts(e),r=null;for(let i of t.contents){let s=[i,void 0,y(i,n)];if(r&&e.sortKeys(r,s)>=0)throw Error(`Set items out of order in tag #${g.SET}`);r=s}}return new Set(t.contents)},"Set"),p(Set,(t,e,n)=>{let r=[...t];if(n.sortKeys){let i=r.map((s)=>[s,void 0,y(s,n)]);i.sort(n.sortKeys),r=i.map(([s])=>s)}return[g.SET,r]}),m.registerDecoder(g.JSON,(t)=>(J(t.contents),JSON.parse(t.contents)),"JSON-encoded");function _n(t){return $(t.contents),new W().decode(t.contents)}_n.comment=(t)=>{$(t.contents);let e=new W;return`(WTF8 string): ${JSON.stringify(e.decode(t.contents))}`},m.registerDecoder(g.WTF8,_n),m.registerDecoder(g.SELF_DESCRIBED,(t)=>t.contents,"Self-Described"),m.registerDecoder(g.INVALID_16,()=>{throw Error(`Tag always invalid: ${g.INVALID_16}`)},"Invalid"),m.registerDecoder(g.INVALID_32,()=>{throw Error(`Tag always invalid: ${g.INVALID_32}`)},"Invalid"),m.registerDecoder(g.INVALID_64,()=>{throw Error(`Tag always invalid: ${g.INVALID_64}`)},"Invalid");function Oe(t){throw Error(`Encoding ${t.constructor.name} intentionally unimplmented.  It is not concrete enough to interoperate.  Convert to Uint8Array first.`)}p(ArrayBuffer,Oe),p(DataView,Oe),typeof SharedArrayBuffer<"u"&&p(SharedArrayBuffer,Oe);function se(t){return[NaN,t.valueOf()]}p(Boolean,se),p(Number,se),p(String,se),p(BigInt,se);function On(t){let e={...x.defaultDecodeOptions};if(t.dcbor?Object.assign(e,x.dcborDecodeOptions):t.cde&&Object.assign(e,x.cdeDecodeOptions),Object.assign(e,t),Object.hasOwn(e,"rejectLongNumbers"))throw TypeError("rejectLongNumbers has changed to requirePreferred");return e.boxed&&(e.saveOriginal=!0),e}class Mn{parent=void 0;ret=void 0;step(t,e,n){if(this.ret=x.create(t,this.parent,e,n),t[2]===E.BREAK)if(this.parent?.isStreaming)this.parent.left=0;else throw Error("Unexpected BREAK");else this.parent&&this.parent.push(this.ret,n,t[3]);for(this.ret instanceof x&&(this.parent=this.ret);this.parent?.done;){this.ret=this.parent.convert(n);let r=this.parent.parent;r?.replaceLast(this.ret,this.parent,n),this.parent=r}}}function k(t,e={}){let n=On(e),r=new P(t,n),i=new Mn;for(let s of r)i.step(s,n,r);return i.ret}class Pn{#t;#e;constructor(t,e={}){let n=new P(t,On(e));this.#t=n.seq()}peek(){return this.#e||(this.#e=this.#n()),this.#e}read(){let t=this.#e??this.#n();return this.#e=void 0,t}*[Symbol.iterator](){for(;;){let t=this.read();if(!t)return;yield t}}#n(){let{value:t,done:e}=this.#t.next();if(!e)return t}}function kn(t){return vt(t)}class Mt extends Error{constructor(t){super(t);this.name="CoseError"}}class N extends Mt{keyType;constructor(t,e){super(t);this.keyType=e;this.name="InvalidKeyError"}}class L extends Mt{reason;constructor(t,e){super(t);this.reason=e;this.name="DecryptionError"}}var Me=new St(zt,Dt,Ht);async function Kn(){let{publicKey:t,privateKey:e}=await Me.GenerateKeyPair(!0),n=await Me.SerializePublicKey(t),r=await Me.SerializePrivateKey(e),i=Ln(n),s=ri(n,r);return{publicKey:y(i),privateKey:y(s)}}function Ln(t){if(t.length!==65||t[0]!==4)throw new N("Invalid P-256 public key format","EC2");let e=t.slice(1,33),n=t.slice(33,65),r=new Map;return r.set(nt,et),r.set(me,ue),r.set(ut,e),r.set(mt,n),r}function ri(t,e){if(e.length!==32)throw new N("Invalid P-256 private key format","EC2");let n=Ln(t);return n.set(wt,e),n}function Fn(t){return y(t)}function G(t){let e=k(t);if(!(e instanceof Map))throw new N("COSE_Key must be a CBOR map");let n=e.get(nt);if(n!==et)throw new N(`Unsupported key type: ${n}`,"EC2");return e}function Bn(t){return kn(t)}async function V(t,e){let n=t.get(nt);if(n!==et)throw new N(`Unsupported key type: ${n}`,"EC2");let r=t.get(ut),i=t.get(mt),s=t.get(wt),o={kty:"EC",crv:"P-256",x:ht(r),y:ht(i)};if(e==="private"){if(!s)throw new N("Private key requires d parameter","EC2");o.d=ht(s)}let a=e==="private"?["deriveBits","deriveKey"]:[];return crypto.subtle.importKey("jwk",o,{name:"ECDH",namedCurve:"P-256"},!0,a)}async function $n(t){if(t.kty!=="EC"||t.crv!=="P-256")throw new N("Only P-256 EC keys supported",t.kty??"unknown");if(!t.x||!t.y)throw new N("JWK missing x or y coordinate","EC");let e=new Map;if(e.set(nt,et),e.set(me,ue),e.set(ut,Pe(t.x)),e.set(mt,Pe(t.y)),t.d)e.set(wt,Pe(t.d));return y(e)}async function Gn(t){let e=G(t),n=e.get(nt);if(n!==et)throw new N(`Unsupported key type for JWK: ${n}`,"EC2");let r=e.get(ut),i=e.get(mt),s=e.get(wt),o={kty:"EC",crv:"P-256",x:ht(r),y:ht(i)};if(s)o.d=ht(s);return o}function ht(t){let e=String.fromCharCode(...t);return btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function Pe(t){let e=t.replace(/-/g,"+").replace(/_/g,"/");while(e.length%4!==0)e+="=";let n=atob(e),r=new Uint8Array(n.length);for(let i=0;i<n.length;i++)r[i]=n.charCodeAt(i);return r}function lt(){return new St(zt,Dt,Ht)}function ae(t){let e=new Map;return e.set(Re,t),y(e)}function fe(t){let e=new Map;return e.set(rt,t),e}function Y(t,e,n=new Uint8Array){return y([t,e,n])}function Rn(t){return y(new m(gt,[t.protectedHeader,t.unprotectedHeader,t.ciphertext]))}function jn(t){let e=k(t),n;if(e instanceof m){if(e.tag!==gt)throw Error(`Expected COSE_Encrypt0 tag (16), got ${e.tag}`);n=e.contents}else if(Array.isArray(e))n=e;else throw Error("Invalid COSE_Encrypt0 structure");if(n.length!==3)throw Error("COSE_Encrypt0 must have 3 elements");return{protectedHeader:n[0],unprotectedHeader:n[1],ciphertext:n[2]}}async function zn(t,e){let n=lt(),r=G(e),i=await V(r,"public"),s=ae($e),o=Y("Encrypt0",s),{encapsulatedSecret:a,ciphertext:f}=await n.Seal(i,t,{aad:o}),h=fe(new Uint8Array(a));return Rn({protectedHeader:s,unprotectedHeader:h,ciphertext:new Uint8Array(f)})}async function ke(t,e){let n=lt(),r=jn(t),i=r.unprotectedHeader.get(rt);if(!i)throw new L("Missing encapsulated key (ek) in header");let s=G(e),o=await V(s,"private"),a=Y("Encrypt0",r.protectedHeader);try{let f=await n.Open(o,i,r.ciphertext,{aad:a});return new Uint8Array(f)}catch(f){throw new L("Decryption failed",f instanceof Error?f.message:"Unknown error")}}function Hn(t){return[t.protectedHeader,t.unprotectedHeader,t.ciphertext]}function qn(t){if(t.length!==3)throw Error("COSE_recipient must have 3 elements");return{protectedHeader:t[0],unprotectedHeader:t[1],ciphertext:t[2]}}function Wn(t){let e=t.recipients.map(Hn);return y(new m(dt,[t.protectedHeader,t.unprotectedHeader,t.ciphertext,e]))}function Cn(t){let e=k(t),n;if(e instanceof m){if(e.tag!==dt)throw Error(`Expected COSE_Encrypt tag (96), got ${e.tag}`);n=e.contents}else if(Array.isArray(e))n=e;else throw Error("Invalid COSE_Encrypt structure");if(n.length!==4)throw Error("COSE_Encrypt must have 4 elements");let i=n[3].map(qn);return{protectedHeader:n[0],unprotectedHeader:n[1],ciphertext:n[2],recipients:i}}var ii=32,si=12,Xn=5;async function Zn(t,e){if(e.length===0)throw new N("At least one recipient required");let n=crypto.getRandomValues(new Uint8Array(ii)),r=y(new Map),i=crypto.getRandomValues(new Uint8Array(si)),s=await crypto.subtle.importKey("raw",n,{name:"AES-GCM",length:256},!1,["encrypt"]),o=Y("Encrypt",r),a=await crypto.subtle.encrypt({name:"AES-GCM",iv:i,additionalData:o},s,t),f=new Map;f.set(Xn,i);let h=[],l=lt();for(let u of e){let d=G(u),F=await V(d,"public"),v=ae(Ge),Q=Y("Enc_Recipient",v),{encapsulatedSecret:Ft,ciphertext:he}=await l.Seal(F,n,{aad:Q}),le=fe(new Uint8Array(Ft));h.push({protectedHeader:v,unprotectedHeader:le,ciphertext:new Uint8Array(he)})}return Wn({protectedHeader:r,unprotectedHeader:f,ciphertext:new Uint8Array(a),recipients:h})}async function Ke(t,e){let n=lt(),r=Cn(t),i=G(e),s=await V(i,"private"),o=null;for(let l of r.recipients)try{let u=l.unprotectedHeader.get(rt);if(!u)continue;let d=Y("Enc_Recipient",l.protectedHeader),F=await n.Open(s,u,l.ciphertext,{aad:d});o=new Uint8Array(F);break}catch{continue}if(!o)throw new L("No matching recipient found for the provided key");let a=r.unprotectedHeader.get(Xn);if(!a)throw new L("Missing IV in content unprotected header");let f=await crypto.subtle.importKey("raw",o,{name:"AES-GCM",length:256},!1,["decrypt"]),h=Y("Encrypt",r.protectedHeader);try{let l=await crypto.subtle.decrypt({name:"AES-GCM",iv:a,additionalData:h},f,r.ciphertext);return new Uint8Array(l)}catch(l){throw new L("Content decryption failed",l instanceof Error?l.message:"Unknown error")}}async function ci(t,e){if(e.length===0)throw new N("At least one recipient required");if(e.length===1)return zn(t,e[0]);return Zn(t,e)}async function hi(t,e){let n=k(t);if(n instanceof m){if(n.tag===gt)return ke(t,e);if(n.tag===dt)return Ke(t,e);throw new N(`Unknown COSE tag: ${n.tag}`)}if(Array.isArray(n)){if(n.length===3)return ke(t,e);if(n.length===4)return Ke(t,e)}throw new N("Unable to determine COSE message type")}ce();var Qn=2097152,li="https://cose-hpke.github.io/decrypt";class tr extends Error{actualSize;maxSize;constructor(t,e){let n=(t/1048576).toFixed(2),r=(e/1048576).toFixed(2);super(`URL exceeds maximum length: ${n}MB > ${r}MB limit`);this.name="UrlTooLargeError",this.actualSize=t,this.maxSize=e}}async function Sa(t,e=li){let{encodeFragment:n}=await Promise.resolve().then(() => (ce(),Be)),r=await n(t),i=`${e}#${r}`;if(i.length>Qn)throw new tr(i.length,Qn);return i}async function Da(t){let{decodeFragment:e}=await Promise.resolve().then(() => (ce(),Be)),r=new URL(t).hash.slice(1);if(!r)throw Error("URL has no fragment");return e(r)}export{Gn as toJwk,Bn as toDiagnostic,Lt as toBase64Url,Da as parseShareableUrl,Kt as isCompressionAvailable,Kn as generateKeyPair,$n as fromJwk,Fe as fromBase64Url,ci as encrypt,Vn as encodeFragment,Fn as encodeCoseKey,hi as decrypt,kt as decompress,Yn as decodeFragment,G as decodeCoseKey,Sa as createShareableUrl,V as coseKeyToCryptoKey,Pt as compress,tr as UrlTooLargeError,Qn as MAX_URL_LENGTH,N as InvalidKeyError,L as DecryptionError,Mt as CoseError,li as BASE_URL};

//# debugId=2A84CA3872A1F26B64756E2164756E21
//# sourceMappingURL=lib.js.map
