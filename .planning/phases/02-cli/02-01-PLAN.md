---
phase: 02-cli
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/cli/index.ts
  - src/cli/commands/keygen.ts
  - src/cli/util/format.ts
autonomous: true

must_haves:
  truths:
    - "User can run `bun run cli keygen` and see a keypair"
    - "Public and private keys are displayed in CDDL diagnostic notation"
    - "Hex-encoded CBOR is shown alongside diagnostic notation"
    - "User can save keys to binary files with --output-public and --output-private flags"
  artifacts:
    - path: "src/cli/index.ts"
      provides: "CLI entry point with citty runMain"
      exports: ["main command with subCommands"]
    - path: "src/cli/commands/keygen.ts"
      provides: "keygen subcommand"
      exports: ["default keygen command"]
    - path: "src/cli/util/format.ts"
      provides: "Output formatting utilities"
      exports: ["formatKeyOutput"]
  key_links:
    - from: "src/cli/commands/keygen.ts"
      to: "src/cose/key.ts"
      via: "generateKeyPair import"
      pattern: "import.*generateKeyPair.*from"
    - from: "src/cli/index.ts"
      to: "src/cli/commands/keygen.ts"
      via: "subCommands registration"
      pattern: "subCommands.*keygen"
---

<objective>
Set up CLI infrastructure with citty framework and implement the keygen command.

Purpose: Establish the CLI foundation and deliver the first user-facing command for keypair generation.
Output: Working `bun run cli keygen` command that outputs P-256 keypair in CDDL diagnostic notation, with optional file output.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-cli/02-CONTEXT.md
@.planning/phases/02-cli/02-RESEARCH.md
@src/index.ts
@src/cose/key.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install citty and set up CLI entry point</name>
  <files>
    - package.json
    - src/cli/index.ts
    - src/cli/util/format.ts
  </files>
  <action>
1. Install citty: `bun add citty`

2. Create src/cli/util/format.ts with formatKeyOutput function:
   - Takes CBOR-encoded key bytes and label string
   - Uses toDiagnostic() from src/cose/key.ts for CDDL diagnostic notation
   - Returns formatted string with diagnostic notation and hex-encoded CBOR
   - Format:
     ```
     {label}:
       {diagnostic notation}

       CBOR (hex): {hex string}
     ```

3. Create src/cli/index.ts:
   - Add shebang: `#!/usr/bin/env bun`
   - Import defineCommand, runMain from citty
   - Define main command with meta (name: 'cose-hpke', version from package.json, description)
   - Empty subCommands object for now (will add keygen in Task 2)
   - Call runMain(main)

4. Add to package.json scripts:
   - `"cli": "bun run src/cli/index.ts"`

5. Add to package.json bin:
   - `"bin": { "cose-hpke": "./src/cli/index.ts" }`
  </action>
  <verify>
    - `bun run cli --help` shows help text with version and description
    - `bun run cli --version` shows version number
  </verify>
  <done>
    CLI entry point responds to --help and --version flags
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement keygen command with file output options</name>
  <files>
    - src/cli/commands/keygen.ts
    - src/cli/index.ts
  </files>
  <action>
1. Create src/cli/commands/keygen.ts:
   - Import defineCommand from citty
   - Import generateKeyPair, toDiagnostic, publicKeyFromPrivate from library (src/index.ts or src/cose/key.ts)
   - Import formatKeyOutput from ../util/format.ts
   - Define command with:
     - meta: { name: 'keygen', description: 'Generate a new COSE-HPKE P-256 keypair' }
     - args:
       - output-public: { type: 'string', description: 'Save public key CBOR bytes to file' }
       - output-private: { type: 'string', description: 'Save private key CBOR bytes to file' }
     - async run({ args }):
       - Generate keypair
       - If args['output-public']:
         - Write raw CBOR bytes of public key to specified file using Bun.write()
         - console.log(`Public key saved to: ${args['output-public']}`)
       - If args['output-private']:
         - Write raw CBOR bytes of private key to specified file using Bun.write()
         - console.log(`Private key saved to: ${args['output-private']}`)
       - If neither output flag provided:
         - Output formatted keys to console (diagnostic notation + hex CBOR)
   - Output format for console (when no --output flags):
     ```
     Public Key:
       {1: 2, -1: 1, -2: h'...', -3: h'...'}

       CBOR (hex): a4010220...

     Private Key:
       {1: 2, -1: 1, -2: h'...', -3: h'...', -4: h'...'}

       CBOR (hex): a5010220...
     ```
   - Export default command

2. Update src/cli/index.ts:
   - Import keygen from './commands/keygen.ts'
   - Add to subCommands: { keygen }
  </action>
  <verify>
    - `bun run cli keygen` outputs public and private keys to console
    - Output contains CDDL diagnostic notation (curly braces, h'' hex strings)
    - Output contains "CBOR (hex):" followed by hex string
    - `bun run cli keygen --output-public /tmp/pub.cose --output-private /tmp/priv.cose` creates both files
    - Files contain raw CBOR bytes (verify with `xxd /tmp/pub.cose | head` shows binary content starting with 0xa4 or 0xa5)
    - No errors thrown
  </verify>
  <done>
    keygen command generates and displays keypair in CDDL diagnostic + hex CBOR format, and can save binary keys to files
  </done>
</task>

<task type="auto">
  <name>Task 3: Add CLI tests</name>
  <files>
    - test/cli-keygen.test.ts
  </files>
  <action>
1. Create test/cli-keygen.test.ts:
   - Import Bun shell or spawn to run CLI commands
   - Import node:fs for cleanup
   - Test cases:
     a. `bun run cli --help` contains "cose-hpke" and "keygen"
     b. `bun run cli keygen` exits with code 0
     c. `bun run cli keygen` output contains "Public Key:"
     d. `bun run cli keygen` output contains "Private Key:"
     e. `bun run cli keygen` output contains "CBOR (hex):"
     f. `bun run cli keygen` output contains diagnostic notation markers (h' for hex bytes)
     g. `bun run cli keygen --output-public /tmp/test-pub.cose --output-private /tmp/test-priv.cose`:
        - Creates both files
        - Files start with valid CBOR map bytes (0xa4 for public, 0xa5 for private)
        - Files can be read back as valid COSE keys (import from library and decode)

2. Use Bun.spawn or $ shell tag for running commands:
   ```typescript
   import { $ } from 'bun';
   const result = await $`bun run cli keygen`.text();
   ```

3. Clean up temp files after tests
  </action>
  <verify>
    - `bun test test/cli-keygen.test.ts` passes all tests
  </verify>
  <done>
    CLI keygen command has test coverage for help, output format, exit code, and file output
  </done>
</task>

</tasks>

<verification>
Overall phase checks:
1. `bun run cli --help` shows help with keygen subcommand listed
2. `bun run cli keygen` produces valid output with CDDL diagnostic notation
3. `bun run cli keygen --output-public pub.cose --output-private priv.cose` creates binary key files
4. `bun test` passes (including new CLI tests)
5. No TypeScript errors: `bun run typecheck`
</verification>

<success_criteria>
- citty installed and CLI entry point functional
- keygen command generates keypair and outputs in CDDL diagnostic format with hex CBOR
- keygen --output-public and --output-private flags save binary CBOR to files
- Help text shows available commands
- Tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-cli/02-01-SUMMARY.md`
</output>
