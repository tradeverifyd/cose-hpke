---
phase: 04-web-demo
plan: 03
type: execute
wave: 3
depends_on: [04-02]
files_modified:
  - .github/workflows/pages.yml
  - package.json
autonomous: true
user_setup:
  - service: github-pages
    why: "Host the demo at a public URL"
    dashboard_config:
      - task: "Enable GitHub Pages from Actions"
        location: "Repository Settings -> Pages -> Source -> GitHub Actions"

must_haves:
  truths:
    - "GitHub Actions workflow exists for Pages deployment"
    - "Workflow triggers on push to main"
    - "Workflow builds the demo directory"
    - "Demo is accessible at GitHub Pages URL"
  artifacts:
    - path: ".github/workflows/pages.yml"
      provides: "GitHub Pages deployment workflow"
      contains: "deploy-pages"
      min_lines: 30
  key_links:
    - from: ".github/workflows/pages.yml"
      to: "demo/"
      via: "upload-pages-artifact"
      pattern: "path:\\s*demo"
---

<objective>
Deploy the web demo to GitHub Pages via GitHub Actions.

Purpose: Make the demo publicly accessible so users can encrypt/decrypt messages without installing anything.
Output: GitHub Actions workflow that automatically deploys the demo on every push to main.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-web-demo/04-CONTEXT.md
@.planning/phases/04-web-demo/04-RESEARCH.md
@.planning/phases/04-web-demo/04-01-SUMMARY.md
@.planning/phases/04-web-demo/04-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions workflow for Pages deployment</name>
  <files>
    .github/workflows/pages.yml
  </files>
  <action>
Create `.github/workflows/pages.yml`:

```yaml
name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build browser bundle
        run: bun run build:demo

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: demo/

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
```

This workflow:
1. Triggers on push to main or manual dispatch
2. Sets up Bun and installs dependencies
3. Builds the browser bundle (bun run build:demo)
4. Uploads the demo/ directory as a Pages artifact
5. Deploys to GitHub Pages
  </action>
  <verify>
- File exists at `.github/workflows/pages.yml`
- YAML is valid (no syntax errors)
- Workflow has build and deploy jobs
- Uses oven-sh/setup-bun@v2
- Uses actions/upload-pages-artifact@v3
- Uses actions/deploy-pages@v4
- Path is set to `demo/`
  </verify>
  <done>
GitHub Actions workflow exists that builds the demo and deploys to GitHub Pages.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update BASE_URL in browser module for production</name>
  <files>
    src/browser.ts
    demo/index.html
  </files>
  <action>
The BASE_URL is already set correctly in src/url/index.ts as 'https://cose-hpke.github.io/decrypt'.

However, the actual GitHub Pages URL will be based on the repository name. Check the current repository name and update if needed.

1. Check the git remote to determine the actual URL:
   ```bash
   git remote get-url origin
   ```

2. The URL pattern will be: `https://{owner}.github.io/{repo}/`

3. For this repo, if the remote is `github.com/or13/cose-hpke` (or similar), the Pages URL would be `https://or13.github.io/cose-hpke/`

4. Update the BASE_URL in src/browser.ts to match the actual deployment URL. Since the demo is at the root of the repo (demo/index.html), the decrypt URL should just be the base.

Actually, looking at the URL transport module, the BASE_URL is used for creating shareable URLs. The structure is:
- `BASE_URL#fragment`

For GitHub Pages, the demo will be at `https://{owner}.github.io/{repo}/` and the hash fragment will be appended.

Since we don't know the exact username, leave the placeholder URL and add a comment. The user can update it after deployment.

No changes needed - the BASE_URL in the code is a placeholder. When users share URLs, they'll naturally copy the actual deployed URL which will have the correct base.

5. Add a meta tag to index.html for the base URL (for relative imports):
   ```html
   <base href="./">
   ```
   This ensures relative imports work correctly on GitHub Pages.

Actually, the base tag is already implicitly relative. No changes needed.

6. Verify build:demo script exists in package.json (added in Plan 01).
  </action>
  <verify>
- `git remote get-url origin` shows the repository URL
- `package.json` has `build:demo` script
- Workflow YAML references `bun run build:demo`
  </verify>
  <done>
Configuration verified for GitHub Pages deployment. BASE_URL is a placeholder that works for any deployment.
  </done>
</task>

<task type="auto">
  <name>Task 3: Test workflow locally and commit</name>
  <files>
    (no new files)
  </files>
  <action>
1. Verify the demo builds successfully:
   ```bash
   bun run build:demo
   ls -la demo/
   ```

2. Verify all demo files exist:
   - demo/index.html
   - demo/app.js
   - demo/keystore.js
   - demo/lib.js

3. Run all tests to ensure nothing is broken:
   ```bash
   bun test
   ```

4. Commit the workflow file:
   ```bash
   git add .github/workflows/pages.yml
   git commit -m "ci: add GitHub Pages deployment workflow

   - Build demo with bun run build:demo
   - Deploy demo/ directory to Pages
   - Triggers on push to main"
   ```

5. Inform user about the manual step required:
   After pushing to GitHub, user needs to:
   - Go to Repository Settings -> Pages
   - Under "Build and deployment", select "Source: GitHub Actions"
   - The workflow will then run and deploy the demo
  </action>
  <verify>
- `bun test` passes
- `demo/` directory contains all required files
- `.github/workflows/pages.yml` is committed
- User is informed about the GitHub Pages source setting
  </verify>
  <done>
GitHub Actions workflow committed. User needs to enable GitHub Pages from Actions in repository settings for deployment to work.
  </done>
</task>

</tasks>

<verification>
Build works:
```bash
bun run build:demo
ls -la demo/
```

Tests pass:
```bash
bun test
```

Workflow file is valid YAML:
```bash
cat .github/workflows/pages.yml
```
</verification>

<success_criteria>
1. .github/workflows/pages.yml exists with correct structure
2. Workflow triggers on push to main
3. Workflow builds demo with Bun
4. Workflow deploys demo/ directory to Pages
5. All tests continue to pass
6. User understands they need to enable GitHub Pages from Actions in settings
</success_criteria>

<output>
After completion, create `.planning/phases/04-web-demo/04-03-SUMMARY.md`
</output>
